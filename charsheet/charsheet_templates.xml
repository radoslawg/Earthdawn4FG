<?xml version="1.0" encoding="iso-8859-1"?>
<root version="2.0">

	<template name="attributefield"> <!--{{{-->
		<numberfield>
			<frame>
				<name>modifier</name>
				<offset>5,5,5,5</offset>
			</frame>
			<keyeditframe>
				<name>sheetfocus</name>
				<offset>5,5,5,5</offset>
			</keyeditframe>
			<font>sheetnumber</font>
			<noreset />
			<script file="scripts/template_attribute_field.lua" />
		</numberfield>
	</template><!--}}}-->

	<template name="textlistitemvalue"><!--{{{-->
		<stringfield name="value">
			<font>sheettext</font>
			<!--<multilinespacing>20</multilinespacing>-->
			<frame>
				<name>textline</name>
			</frame>
			<script>
				function onEnter()
--[[
					local new = window.windowlist.createWindow();
					new[getName()].setFocus();
]]
					onNavigateDown();
				end
				
				function onNavigateDown()
					local next = window.windowlist.getNextWindow(window);
					if next then
						next[getName()].setFocus();
						next[getName()].setCursorPosition(1);
						next[getName()].setSelectionPosition(1);
					end
				end
				
				function onNavigateUp()
					local prev = window.windowlist.getPrevWindow(window);
					if prev then
						prev[getName()].setFocus();
						prev[getName()].setCursorPosition(#prev[getName()].getValue()+1);
						prev[getName()].setSelectionPosition(#prev[getName()].getValue()+1);
					end
				end
				
				function onNavigateRight()
					if tabtarget and tabtarget[1] and tabtarget[1].next and tabtarget[1].next[1] then
						local target = window[tabtarget[1].next[1]];

						if type(target) == "stringcontrol" then
							target.setFocus();
							target.setCursorPosition(1);
							target.setSelectionPosition(1);
						end
					end
				end
				
				function onNavigateLeft()
					if tabtarget and tabtarget[1] and tabtarget[1].prev and tabtarget[1].prev[1] then
						local target = window[tabtarget[1].prev[1]];

						if type(target) == "stringcontrol" then
							target.setFocus();
							target.setCursorPosition(#target.getValue()+1);
							target.setSelectionPosition(#target.getValue()+1);
						end
					end
				end
				
--[[
				function onDeleteUp()
					if getValue() == "" and not nodelete then
						local target = window.windowlist.getPrevWindow(window);
						if target then
							target[getName()].setFocus();
							target[getName()].setCursorPosition(#target[getName()].getValue()+1);
							target[getName()].setSelectionPosition(#target[getName()].getValue()+1);
						end
						
						window.getDatabaseNode().delete();
					end
				end
				
				function onDeleteDown()
					if getValue() == "" and not nodelete then
						local target = window.windowlist.getNextWindow(window);
						if target then
							target[getName()].setFocus();
							target[getName()].setCursorPosition(1);
							target[getName()].setSelectionPosition(1);
						end
						
						window.getDatabaseNode().delete();
					end
				end
]]
				
				function onGainFocus()
					window.setFrame("rowshade");
					setColor("#FF990099");
				end
				
				function onLoseFocus()
					window.setFrame(nil);
					setColor(nil);
				end
				function onHover(state)
					if state then
						setColor("#FF990099");
						window.setFrame("rowshade");
					else
						if hasFocus() == false then
							setColor(nil);
							window.setFrame(nil);
						end
					end
				end
			</script>
		</stringfield>
	</template><!--}}}-->
	
	<template name="textlistitemnumber"><!--{{{-->
		<numberfield name="value">
			<font>sheettext</font>
			<frame>
				<name>textline</name>
			</frame>
			<script>
				function onEnter()
--[[
					local new = window.windowlist.createWindow();
					new[getName()].setFocus();
]]
					onNavigateDown();
				end
				
				function onNavigateDown()
					local next = window.windowlist.getNextWindow(window);
					if next then
						next[getName()].setFocus();
						next[getName()].setCursorPosition(1);
						next[getName()].setSelectionPosition(1);
					end
				end
				
				function onNavigateUp()
					local prev = window.windowlist.getPrevWindow(window);
					if prev then
						prev[getName()].setFocus();
						prev[getName()].setCursorPosition(#prev[getName()].getValue()+1);
						prev[getName()].setSelectionPosition(#prev[getName()].getValue()+1);
					end
				end
				
				function onNavigateRight()
					if tabtarget and tabtarget[1] and tabtarget[1].next and tabtarget[1].next[1] then
						local target = window[tabtarget[1].next[1]];

						if type(target) == "stringcontrol" then
							target.setFocus();
							target.setCursorPosition(1);
							target.setSelectionPosition(1);
						end
					end
				end
				
				function onNavigateLeft()
					if tabtarget and tabtarget[1] and tabtarget[1].prev and tabtarget[1].prev[1] then
						local target = window[tabtarget[1].prev[1]];

						if type(target) == "stringcontrol" then
							target.setFocus();
							target.setCursorPosition(#target.getValue()+1);
							target.setSelectionPosition(#target.getValue()+1);
						end
					end
				end
				
--[[
				function onDeleteUp()
					if getValue() == "" and not nodelete then
						local target = window.windowlist.getPrevWindow(window);
						if target then
							target[getName()].setFocus();
							target[getName()].setCursorPosition(#target[getName()].getValue()+1);
							target[getName()].setSelectionPosition(#target[getName()].getValue()+1);
						end
						
						window.getDatabaseNode().delete();
					end
				end
				
				function onDeleteDown()
					if getValue() == "" and not nodelete then
						local target = window.windowlist.getNextWindow(window);
						if target then
							target[getName()].setFocus();
							target[getName()].setCursorPosition(1);
							target[getName()].setSelectionPosition(1);
						end
						
						window.getDatabaseNode().delete();
					end
				end
]]
				
				function onGainFocus()
					window.setFrame("rowshade");
					setColor("#FF4444FF");
				end
				
				function onLoseFocus()
					window.setFrame(nil);
					setColor(nil);
				end

				function onWheel()
					return false;
				end

				function onHover(state)
					if state then
						setColor("#FF4444FF");
						window.setFrame("rowshade");
					else
						if hasFocus() == false then
							setColor(nil);
							window.setFrame(nil);
						end
					end
				end

			</script>
		</numberfield>
	</template><!--}}}-->

	<windowclass name="lpinc"> <!--{{{-->
		<frame>sheetgroup</frame>
		<sheetdata>
			<stringcontrol name="label">
				<bounds>25,15,155,25</bounds>
				<font>sheetlabel</font>
			</stringcontrol>
			
			<stringcontrol>
				<bounds>15,40,45,20</bounds>
				<font>sheetlabelsmallbold</font>
				<static>Bonus</static>
			</stringcontrol>
			
			<stringcontrol>
				<bounds>85,40,45,20</bounds>
				<font>sheetlabelsmallbold</font>
				<static>LP Cost</static>
			</stringcontrol>
			
			<!-- Basics -->
			<numberfield name="LPbonustotal">
				<bounds>15,50,35,20</bounds>
				<font>sheetnumbersmall</font>
				<frame>
					<name>modifier</name>
					<offset>2,2,2,2</offset>
				</frame>
				<displaysign />
			</numberfield>
			
			<numberfield name="lpcost">
				<bounds>75,50,75,20</bounds>
				<font>sheetnumbersmall</font>
				<frame>
					<name>modifier</name>
					<offset>2,2,2,2</offset>
				</frame>
			</numberfield>
		</sheetdata>
	</windowclass><!--}}}-->

	<windowclass name="knotes"> <!--{{{-->
		<frame>referencebox</frame>
		<sheetdata>
			<stringcontrol name="label">
				<bounds>25,9,355,25</bounds>
				<font>titlefont</font>
				<center />
				<invisible />
			</stringcontrol>

			<stringcontrol name="label2">
				<bounds>25,9,355,25</bounds>
				<font>titlefont</font>
				<center />
			</stringcontrol>

			<genericcontrol name="frame">
				<bounds>5,15,400,300</bounds>
				<!-- <frame>
					<name>modifier</name>
				</frame> -->
			</genericcontrol>
			
			<genericcontrol name="halfframe">
				<bounds>10,35,381,70</bounds>
				<frame>
					<name>sheetgroup</name>
				</frame>
			</genericcontrol>


			<stringcontrol name="halflabel">
				<anchored>
					<to>halfframe</to>
					<position>above</position>
					<offset>-153,-8</offset>
				</anchored>
				<frame>
					<name>modifier</name>
				<offset>10,5,3,5</offset>
				</frame>
				<font>titlefont</font>
				<static>Half-Magic</static>
			</stringcontrol>
			
			<linkednumber name="divhmstep">
				<bounds>20,53,35,35</bounds>
				<invisible />
				<source>
					<name>circle</name>
					<op>+</op>
				</source>
				<script>
					function onSourceUpdate()
						setValue(math.ceil(calculateSources() / 2));
					end
				</script>
			</linkednumber>

			<modifiernumber name="hmstep">
				<bounds>20,53,35,35</bounds>
				<frame>
					<name>modifier</name>
					<offset>3,3,3,3</offset>
				</frame>
				<font>sheetnumber</font>
				<readonly />
				<source>
					<name>divhmstep</name>
					<op>+</op>
				</source>
				<modifierfield>hmstep.temp</modifierfield>
				<description>Half-Magic</description>
				<script>
					
					function onDrag(button,x,y,dragdata)
						dragdata.setType("dice");
						dragdata.setSlot(1);
						dice = {};
						mod = 0;
						dice, mod = Step.getStepDice(getValue());
						dragdata.setDieList(dice);
						
						dragdata.setDescription(window.label.getValue() .. " Half-Magic (Step " .. getValue() .. ")");
						dragdata.setNumberData(mod);
						
						return true;
					end	

					function onDoubleClick()
						dice = {};
						mod = 0;
						dice, mod = Step.getStepDice(getValue());
						ChatManager.control.throwDice("dice",dice, mod, window.label.getValue() .. " Half-Magic (Step " .. getValue() .. ")");
					end
				</script>
			</modifiernumber>

			
			<windowlist name="halfmagicnoteslist">
				<bounds>65,50,315,40</bounds>
				<datasource>.halfmagicnotes</datasource>
				<class>halfmagicnotes_listitem</class>
				<allowcreate />
				<allowdelete />
				<skipempty />
			</windowlist>
            <scrollbar>
				<target>halfmagicnoteslist</target>
                <anchored to="halfmagicnoteslist" />                
            </scrollbar>			
			<genericcontrol name="discframe">
				<bounds>10,110,381,192</bounds>
				<frame>
					<name>sheetgroup</name>
				</frame>
			</genericcontrol>
			<stringcontrol name="disclabel">
				<anchored>
					<to>discframe</to>
					<position>above</position>
					<offset>-136,-8</offset>
				</anchored>
				<frame>
					<name>modifier</name>
				<offset>10,5,3,5</offset>
				</frame>
				<font>titlefont</font>
				<static>Discipline Notes</static>
			</stringcontrol>

			<windowlist name="discnoteslist">
				<anchored>
					<to>discframe</to>
					<position>over</position>
					<offset>-14,-9</offset>
					<top>
						<parent>frame</parent>
						<offset>109</offset>
					</top>
				</anchored>

				<datasource>.discnotes</datasource>
				<class>discnotes_listitem</class>
				<allowcreate />
				<allowdelete />
				<skipempty />
			</windowlist>
            <scrollbar>
				<target>discnoteslist</target>
                <anchored to="discnoteslist" />                
            </scrollbar>			
			<closebutton_charsheet />

		</sheetdata>
	</windowclass><!--}}}-->

	<windowclass name="discnotes_listitem"><!--{{{-->
		<sizelimits>
			<minimum>
				<height>25</height>
			</minimum>
		</sizelimits>
		<sheetdata>
			
			<textlistitemvalue name="discnotes">
				<anchored>
					<left>
						<anchor>left</anchor>
						<offset>0</offset>
					</left>
					<top>
						<anchor>top</anchor>
						<offset>5</offset>
					</top>
					<size>
						<width>330</width>
					</size>
				</anchored>
				<font>sheettextsmall</font>
			</textlistitemvalue>
			<windowreferencefield name="discnotes_shortcut">
				<anchored>
					<right>
						<anchor>right</anchor>
						<offset>-2</offset>
					</right>
					<top>
						<anchor>top</anchor>
					</top>
					<size>
						<width>20</width>
						<height>20</height>
					</size>
				</anchored>
				<icon>
					<normal>button_openwindow</normal>
					<empty>button_emptytarget</empty>
					<pressed>button_emptytarget</pressed>
				</icon>
				<allowdrop />
			</windowreferencefield>

		</sheetdata>
	</windowclass><!--}}}-->

	<windowclass name="halfmagicnotes_listitem"><!--{{{-->
		<sizelimits>
			<minimum>
				<height>25</height>
			</minimum>
		</sizelimits>
		<sheetdata>
			<textlistitemvalue name="halfmagicnotes">
				<anchored>
					<left>
						<anchor>left</anchor>
						<offset>0</offset>
					</left>
					<top>
						<anchor>top</anchor>
						<offset>0</offset>
					</top>
					<size>
						<width>280</width>
					</size>
				</anchored>
				<font>sheettextsmall</font>
			</textlistitemvalue>
			<windowreferencefield name="halfmagicnotes_shortcut">
				<anchored>
					<right>
						<anchor>right</anchor>
						<offset>-2</offset>
					</right>
					<top>
						<anchor>top</anchor>
					</top>
					<size>
						<width>20</width>
						<height>20</height>
					</size>
				</anchored>
				<icon>
					<normal>button_openwindow</normal>
					<empty>button_emptytarget</empty>
					<pressed>button_emptytarget</pressed>
				</icon>
				<allowdrop />
			</windowreferencefield>

		</sheetdata>
	</windowclass><!--}}}-->
	
	<windowclass name="weaponnotes"><!--{{{-->
		<frame>sheetgroup</frame>
		<placement>
			<size>
				<height>200</height>
				<width>310</width>
			</size>
		</placement>
		<sheetdata>
			<stringcontrol name="label">
				<bounds>25,15,155,25</bounds>
				<font>sheetlabel</font>
			</stringcontrol>
			
			<genericcontrol name="frame">
				<bounds>5,15,300,120</bounds>
				<!-- <frame>
					<name>modifier</name>
				</frame> -->
			</genericcontrol>
			
			<stringfield name="notes">
				<anchored>
					<to>frame</to>
					<position>over</position>
					<offset>-14,-19</offset>
				</anchored>
				<multilinespacing>20</multilinespacing>
				<font>sheettext</font>
				<frame>
					<name>textline</name>
					<offset>2,0,2,0</offset>
				</frame>
			</stringfield>
			<numberfield name="maxammo">
				<bounds>60,150,25,20</bounds>
				<frame>
					<name>modifier</name>
					<offset>5,5,5,5</offset>
				</frame>
				<font>sheetnumber</font>
				<keyeditframe>
					<name>sheetfocus</name>
					<offset>5,5,5,5</offset>
				</keyeditframe>
				<stateframe>
					<drophilight>
						<name>sheetfocus</name>
						<offset>5,5,5,5</offset>
					</drophilight>
				</stateframe>
				<droptypes>
					<type>number</type>
				</droptypes>
				<script>
					function onValueChanged()
						if getValue() &lt; 0 then
							setValue(0);
						elseif getValue() &gt; 40 then
							setValue(40);
						end
					end
				</script>
				<tabtarget>
					<next>critrange</next>
					<prev>rangeincrement</prev>
				</tabtarget>
			</numberfield>
			<stringcontrol>
				<anchored>
					<to>maxammo</to>
					<position>lefthigh</position>
					<offset>3,5</offset>
				</anchored>
				<font>sheetlabel</font>
				<static>Ammo</static>
			</stringcontrol>
			
			<genericcontrol name="ammocounter">
				<bounds>98,150,102,22</bounds>
				<stateicons>
					<on>indicator_checkon</on>
					<off>indicator_checkoff</off>
				</stateicons>
				<spacing>
					<horizontal>10</horizontal>
					<vertical>10</vertical>
				</spacing>
				<slotcount>
					<horizontal>10</horizontal>
					<vertical>2</vertical>
				</slotcount>
				<fields>
					<max>maxammo</max>
					<count>ammo</count>
				</fields>
				<script file="scripts/charsheet_ammocounter.lua" />
			</genericcontrol>
		</sheetdata>
	</windowclass><!--}}}-->
	
	<windowclass name="languagefull"><!--{{{-->
		<frame>referencebox</frame>
		<placement>
			<size>
				<height>300</height>
				<width>192</width>
			</size>
		</placement>
		<minimize>broadcast</minimize>
		<tooltip>
			<field>language</field>
		</tooltip>
		<sheetdata>
			<stringfield name="language">
				<bounds>20,17,152,25</bounds>
				<font>titlefont</font>
				<tabtarget>
					<prev>description</prev>
					<next>rank</next>
				</tabtarget>
				<frame>
					<name>sheetgroup</name>
				<offset>10,7,3,-1</offset>
				</frame>
				<center />
				<script>
					function onGainFocus()
						setColor("#FF990099");
					end
					
					function onLoseFocus()
						setColor(nil);
					end
				</script>

			</stringfield>

			<stringcontrol name="perclabel">
				<bounds>13,37,75,20</bounds>
				<static>Perception</static>
				<font>sheettext</font>
			</stringcontrol>

			<stringcontrol>
				<bounds>83,37,65,20</bounds>
				<static>+</static>
			</stringcontrol>

			
			<stringcontrol name="ranklabel">
				<bounds>93,37,40,20</bounds>
				<font>sheettext</font>
				<static>Rank</static>
			</stringcontrol>

			<stringcontrol>
				<bounds>128,37,65,20</bounds>
				<static>=</static>
			</stringcontrol>
			
			<stringcontrol name="steplabel">
				<bounds>143,37,40,20</bounds>
				<font>sheettext</font>
				<static>Step</static>
			</stringcontrol>
			
			<stringcontrol name="spokenlabel">
				<bounds>15,88,80,20</bounds>
				<font>sheetlabelsmall</font>
				<static>Speak:</static>
			</stringcontrol>

			<checkbox name="spoken">
				<bounds>38,81,25,25</bounds>
				<script>
					function onClickDown(button, x, y)
						setState(not getState());
						if window.spoken.getState() ~= false then
							window.readwrite.setState(0);
						end
					end
				</script>
			</checkbox>
			
			
			<stringcontrol name="readwritelabel">
				<bounds>60,88,75,20</bounds>
				<font>sheetlabelsmall</font>
				<static>Read/Write:</static>
			</stringcontrol>

			<checkbox name="readwrite">
				<bounds>108,81,25,25</bounds>
				<script>
					function onClickDown(button, x, y)
						setState(not getState());
						if window.readwrite.getState() ~= false then
							window.spoken.setState(0);
						end
					end
				</script>
			</checkbox>

			<stringcontrol name="scnoteslabel">
				<bounds>130,88,75,20</bounds>
				<font>sheetlabelsmall</font>
				<static>Notes:</static>
			</stringcontrol>

			<windowreferencefield name="language_notes_shortcut">
				<bounds>150,85,40,20</bounds>
				<icon>
					<normal>button_openwindow</normal>
					<empty>button_emptytarget</empty>
					<pressed>button_emptytarget</pressed>
				</icon>
				<allowdrop />
			</windowreferencefield>
			
						
			<numberfield name="attribute" source="...attributes.perception.step">
				<bounds>35,55,20,25</bounds>
				<font>sheetnumber</font>
				<frame>
					<name>modifier</name>
					<offset>3,3,3,3</offset>
				</frame>
				<keyeditframe>
					<name>sheetfocus</name>
					<offset>3,3,3,3</offset>
				</keyeditframe>
				<readonly />
				<script>
					function onGainFocus()
						setColor("#FF990099");
					end
					
					function onLoseFocus()
						setColor(nil);
					end
				</script>
			</numberfield>
			
			<stringcontrol>
				<bounds>83,55,65,20</bounds>
				<static>+</static>
			</stringcontrol>
			
			<numberfield name="rank">
				<bounds>100,55,20,25</bounds>
				<tabtarget>
					<prev>language</prev>
					<next>description</next>
				</tabtarget>
				<font>sheetnumber</font>
				<frame>
					<name>modifier</name>
					<offset>3,3,3,3</offset>
				</frame>
				<keyeditframe>
					<name>sheetfocus</name>
					<offset>3,3,3,3</offset>
				</keyeditframe>
				<script>
					function onGainFocus()
						setColor("#FF990099");
					end
					
					function onLoseFocus()
						setColor(nil);
					end
					function onHover(state)
						if state then
							setColor("#FF990099");
							setFrame("sheetfocus", 3, 3, 3, 3);
						else
							if hasFocus() == false then
								setColor(nil);
								setFrame("modifier", 3, 3, 3, 3);
							end
						end
					end
				</script>
			</numberfield>

			<stringcontrol>
				<bounds>128,55,65,20</bounds>
				<static>=</static>
			</stringcontrol>
			
	
			<modifiernumber name="step" source="step.total">
				<bounds>145,55,25,25</bounds>
				<frame>
					<name>modifier</name>
					<offset>3,3,3,3</offset>
				</frame>
				<font>sheetnumber</font>
				<readonly />
				<source>
					<name>...attributes.perception.step</name>
					<op>+</op>
				</source>
				<source>
					<name>rank</name>
					<op>+</op>
				</source>
				<modifierfield>step.total.temp</modifierfield>
				<script>
					function onDrag(button,x,y,dragdata)
						dragdata.setType("dice");
						dragdata.setSlot(1);
						dice = {};
						mod = 0;
						dice, mod = Step.getStepDice(getValue());
						dragdata.setDieList(dice);
						
						dragdata.setDescription(window.language.getValue() .. " (Step " .. getValue() .. ")");
						dragdata.setNumberData(mod);
						
						return true;
					end	

					function onDoubleClick()
						dice = {};
						mod = 0;
						dice, mod = Step.getStepDice(getValue());
						ChatManager.control.throwDice("dice",dice, mod, window.language.getValue() .. " (Step " .. getValue() .. ")");
					end
					function onHover(state)
						if state then
							setColor("#FF228822");
							setFrame("sheetfocus", 3, 3, 3, 3);
						else
							if hasFocus() == false then
								setColor(nil);
								setFrame("modifier", 3, 3, 3, 3);
							end
						end
					end
				</script>
			</modifiernumber>		
			
			<genericcontrol name="frame">
				<bounds>5,95,177,200</bounds>
			</genericcontrol>
			
			<stringfield name="description">
				<tabtarget>
					<prev>rank</prev>
					<next>language</next>
				</tabtarget>
				<anchored>
					<to>frame</to>
					<position>over</position>
					<offset>-14,-19</offset>
				</anchored>
				<multilinespacing>12</multilinespacing>
				<font>chatfont</font>
			</stringfield>
			<closebutton_charsheet />
			
		</sheetdata>
	</windowclass>
<!--}}}-->
	
	<windowclass name="matrixfull"><!--{{{-->
		<frame>referencebox</frame>
		<placement>
			<size>
				<height>360</height>
				<width>250</width>
			</size>
		</placement>
		<minimize>grid</minimize>
		<tooltip>
			<field>name</field>
		</tooltip>
		<sheetdata>
			<stringfield name="name">
				<bounds>20,17,210,25</bounds>
				<font>titlefont</font>
				<frame>
					<name>sheetgroup</name>
				<offset>10,7,3,-1</offset>
				</frame>
				<center />
				<tabtarget>
					<prev>description</prev>
					<next>disciplinename</next>
				</tabtarget>
				<script>
					function onGainFocus()
						setColor("#FF990099");
					end
					
					function onLoseFocus()
						setColor(nil);
					end
				</script>
			</stringfield>

			<labeledstring name="disciplinename">
				<bounds>15,36,110,20</bounds>
				<label>discipline</label>
				<tabtarget>
					<prev>name</prev>
					<next>circle</next>
				</tabtarget>
			</labeledstring>

			<labeledstring name="circle">
				<bounds>130,36,35,20</bounds>
				<label>circle</label>
				<center />
				<tabtarget>
					<prev>disciplinename</prev>
					<next>rank</next>
				</tabtarget>
			</labeledstring>

			<stringcontrol name="scnoteslabel">
				<bounds>175,46,75,20</bounds>
				<font>sheetlabelsmall</font>
				<static>Notes:</static>
			</stringcontrol>

			<windowreferencefield name="matrix_notes_shortcut">
				<bounds>195,43,40,20</bounds>
				<icon>
					<normal>button_openwindow</normal>
					<empty>button_emptytarget</empty>
					<pressed>button_emptytarget</pressed>
				</icon>
				<allowdrop />
			</windowreferencefield>

			<stringcontrol name="ranklabel">
				<bounds>16,60,75,20</bounds>
				<font>sheetlabelsmall</font>
				<static>Rank:</static>
			</stringcontrol>

			<numberfield name="rank">
				<bounds>15,72,25,25</bounds>
				<frame>
					<name>modifier</name>
					<offset>3,3,3,3</offset>
				</frame>
				<font>sheetnumber</font>
				<script>
					function onValueChanged()
						if window.spellmatrix.getState() ~= false then
							window.matrixMAtemp.setValue(window.getDatabaseNode().getParent().getParent().getChild("armor.mystic.base").getValue());
							window.matrixDR.setValue(10);
							window.storedthreads.setValue(0);
						elseif window.enhancedmatrix.getState() ~= false then
							window.matrixMAtemp.setValue(window.getDatabaseNode().getParent().getParent().getChild("armor.mystic.base").getValue());
							window.matrixDR.setValue(15);
							window.storedthreads.setValue(1);
						elseif window.armoredmatrix.getState() ~= false then
							window.matrixMAtemp.setValue(window.getDatabaseNode().getParent().getParent().getChild("armor.mystic.base").getValue() + window.rank.getValue());
							window.matrixDR.setValue(25);
							window.storedthreads.setValue(1);
						elseif window.sharedmatrix.getState() ~= false then
							window.matrixMAtemp.setValue(window.getDatabaseNode().getParent().getParent().getChild("armor.mystic.base").getValue() + window.rank.getValue());
							window.matrixDR.setValue(20);
							window.storedthreads.setValue(0);
						else 
							window.matrixMAtemp.setValue(0);
							window.matrixDR.setValue(0);
							window.storedthreads.setValue(0);
						end
					end
					function onGainFocus()
						setColor("#FF990099");
					end
					
					function onLoseFocus()
						setColor(nil);
					end
					function onHover(state)
						if state then
							setColor("#FF990099");
							setFrame("sheetfocus", 3, 3, 3, 3);
						else
							if hasFocus() == false then
								setColor(nil);
								setFrame("modifier", 3, 3, 3, 3);
							end
						end
					end
				</script>
				<keyeditframe>
					<name>sheetfocus</name>
					<offset>3,3,3,3</offset>
				</keyeditframe>
				<tabtarget>
					<prev>circle</prev>
					<next>matrixDT</next>
				</tabtarget>
			</numberfield>

			<stringcontrol name="DTlabel">
				<bounds>55,60,75,20</bounds>
				<font>sheetlabelsmall</font>
				<static>Damage Taken:</static>
			</stringcontrol>

			<numberfield name="matrixDT">
				<bounds>75,72,25,25</bounds>
				<frame>
					<name>modifier</name>
					<offset>3,3,3,3</offset>
				</frame>
				<font>sheetnumber</font>
				<modifierfield>matrixDT.temp</modifierfield>
				<modifierloc>bottomright</modifierloc>
				<script>
					function onGainFocus()
						setColor("#FF990099");
					end
					
					function onLoseFocus()
						setColor(nil);
					end
					function onHover(state)
						if state then
							setColor("#FF882222");
							setFrame("sheetfocus", 3, 3, 3, 3);
						else
							if hasFocus() == false then
								setColor(nil);
								setFrame("modifier", 3, 3, 3, 3);
							end
						end
					end
				</script>
				<keyeditframe>
					<name>sheetfocus</name>
					<offset>3,3,3,3</offset>
				</keyeditframe>
				<tabtarget>
					<prev>rank</prev>
					<next>spellname</next>
				</tabtarget>
			</numberfield>

			<stringcontrol name="DRlabel">
				<bounds>132,60,75,20</bounds>
				<font>sheetlabelsmall</font>
				<static>Rating:</static>
			</stringcontrol>

			<numberfield name="matrixDR">
				<bounds>135,72,25,25</bounds>
				<frame>
					<name>modifier</name>
					<offset>3,3,3,3</offset>
				</frame>
				<font>sheetnumber</font>
				<readonly />
			</numberfield>


			<stringcontrol name="malabel">
				<bounds>172,60,75,20</bounds>
				<font>sheetlabelsmall</font>
				<static>Mystic Armor</static>
			</stringcontrol>

			<numberfield name="matrixMAtemp">
				<bounds>135,72,25,25</bounds>
				<frame>
					<name>modifier</name>
					<offset>3,3,3,3</offset>
				</frame>
				<font>sheetnumber</font>
				<readonly />
				<invisible />
			</numberfield>

			<modifiernumber name="matrixMA">
				<bounds>192,72,25,25</bounds>
				<frame>
					<name>acicon_small</name>
					<offset>2,3,3,3</offset>
				</frame>
				<font>sheetnumber</font>
				<readonly />
				<source>
					<name>matrixMAtemp</name>
					<op>+</op>
				</source>
				<modifierfield>matrixMA.temp</modifierfield>
				<modifierloc>bottomright</modifierloc>
				<script>
					function onHover(state)
						if state then
							setColor("#FF228822");
						else
							if hasFocus() == false then
								setColor(nil);
							end
						end
					end
				</script>
			</modifiernumber>

			<stringcontrol name="spelllabel">
				<bounds>15,100,75,20</bounds>
				<font>sheetlabelsmall</font>
				<static>Spell:</static>
			</stringcontrol>

			<stringfield name="spellname">
				<bounds>50,100,167,10</bounds>
				<frame>
					<name>textline</name>
					<offset>1,5,1,1</offset>
				</frame>
				<font>sheetlabelsmall</font>
				<script>
					function onGainFocus()
						setColor("#FF990099");
					end
					
					function onLoseFocus()
						setColor(nil);
					end
				</script>
				<tabtarget>
					<prev>matrixDT</prev>
					<next>description</next>
				</tabtarget>
			</stringfield>

			<stringcontrol name="threadslabel">
				<bounds>15,116,75,20</bounds>
				<font>sheetlabelsmall</font>
				<static>Stored Threads:</static>
			</stringcontrol>

			<numberfield name="storedthreads">
				<bounds>90,116,15,10</bounds>
				<frame>
					<name>textline</name>
					<offset>1,5,1,1</offset>
				</frame>
				<font>sheetlabelsmall</font>
				<center />
				<readonly />
			</numberfield>


			<stringcontrol name="smlabel">
				<bounds>15,132,75,20</bounds>
				<font>sheetlabelsmall</font>
				<static>Spell Matrix:</static>
			</stringcontrol>

			<checkbox name="spellmatrix">
				<bounds>90,126,25,25</bounds>
				<script>
					function onClickDown(button, x, y)
						setState(not getState());
						if window.spellmatrix.getState() ~= false then
							window.enhancedmatrix.setState(0);
							window.armoredmatrix.setState(0);
							window.sharedmatrix.setState(0);
							window.matrixMAtemp.setValue(window.getDatabaseNode().getParent().getParent().getChild("armor.mystic.base").getValue());
							window.matrixDR.setValue(10);
							window.storedthreads.setValue(0);
						else 
							window.matrixMAtemp.setValue(0);
							window.matrixDR.setValue(0);
							window.storedthreads.setValue(0);
						
						end
					end
				</script>
			</checkbox>

			<stringcontrol name="emlabel">
				<bounds>125,132,75,20</bounds>
				<font>sheetlabelsmall</font>
				<static>Enhanced Matrix:</static>
			</stringcontrol>

			<checkbox name="enhancedmatrix">
				<bounds>200,126,25,25</bounds>
				<script>
					function onClickDown(button, x, y)
						setState(not getState());
						if window.enhancedmatrix.getState() ~= false then
							window.spellmatrix.setState(0);
							window.armoredmatrix.setState(0);
							window.sharedmatrix.setState(0);
							window.matrixMAtemp.setValue(window.getDatabaseNode().getParent().getParent().getChild("armor.mystic.base").getValue());
							window.matrixDR.setValue(15);
							window.storedthreads.setValue(1);
						else 
							window.matrixMAtemp.setValue(0);
							window.matrixDR.setValue(0);
							window.storedthreads.setValue(0);
						end
					end
				</script>
			</checkbox>

			<stringcontrol name="amlabel">
				<bounds>15,148,75,20</bounds>
				<font>sheetlabelsmall</font>
				<static>Armored Matrix:</static>
			</stringcontrol>

			<checkbox name="armoredmatrix">
				<bounds>90,141,25,25</bounds>
				<script>
					function onClickDown(button, x, y)
						setState(not getState());
						if window.armoredmatrix.getState() ~= false then
							window.spellmatrix.setState(0);
							window.enhancedmatrix.setState(0);
							window.sharedmatrix.setState(0);
							window.matrixMAtemp.setValue(window.getDatabaseNode().getParent().getParent().getChild("armor.mystic.base").getValue() + window.rank.getValue());
							window.matrixDR.setValue(25);
							window.storedthreads.setValue(1);
						else 
							window.matrixMAtemp.setValue(0);
							window.matrixDR.setValue(0);
							window.storedthreads.setValue(0);
						end
					end
				</script>
			</checkbox>

			<stringcontrol name="shmlabel">
				<bounds>125,148,75,20</bounds>
				<font>sheetlabelsmall</font>
				<static>Shared Matrix:</static>
			</stringcontrol>

			<checkbox name="sharedmatrix">
				<bounds>200,141,25,25</bounds>
				<script>
					function onClickDown(button, x, y)
						setState(not getState());
						if window.sharedmatrix.getState() ~= false then
							window.spellmatrix.setState(0);
							window.armoredmatrix.setState(0);
							window.enhancedmatrix.setState(0);
							window.matrixMAtemp.setValue(window.getDatabaseNode().getParent().getParent().getChild("armor.mystic.base").getValue() + window.rank.getValue());
							window.matrixDR.setValue(20);
							window.storedthreads.setValue(0);
						else 
							window.matrixMAtemp.setValue(0);
							window.matrixDR.setValue(0);
							window.storedthreads.setValue(0);
						end
					end
				</script>
			</checkbox>





			
			<stringcontrol name="descriptionlabel">
				<bounds>15,165,75,20</bounds>
				<font>sheetlabel</font>
				<static>Description:</static>
			</stringcontrol>
			
			<genericcontrol name="frame">
				<bounds>5,160,235,200</bounds>
			</genericcontrol>
			
			<stringfield name="description">
				<anchored>
					<to>frame</to>
					<position>over</position>
					<offset>-14,-19</offset>
				</anchored>
				<multilinespacing>12</multilinespacing>
				<font>chatfont</font>
				<tabtarget>
					<prev>spellname</prev>
					<next>name</next>
				</tabtarget>
			</stringfield>
			<closebutton_charsheet />
			
		</sheetdata>
	</windowclass><!--}}}-->

 	<windowclass name="attackfull"><!--{{{-->
		<frame>referencebox</frame>
		<placement>
			<size>
				<height>380</height>
				<width>475</width>
			</size>
		</placement>
		<sizelimits>
			<minimum>
				<height>380</height>
				<width>475</width>
			</minimum>
			<maximum>
				<height>380</height>
				<width>475</width>
			</maximum>
		</sizelimits>
		<minimize>minimized_combat</minimize>
		<tooltip>
			<field>name</field>
		</tooltip>
		<sheetdata>
			<stringfield name="name">
				<bounds>20,17,437,25</bounds>
				<font>titlefont</font>
				<tabtarget>
					<prev>description</prev>
					<next>attribname</next>
				</tabtarget>
				<frame>
					<name>sheetgroup</name>
				<offset>10,7,3,-1</offset>
				</frame>
				<center />
				<script>
					function onGainFocus()
						setColor("#FF990099");
					end
					
					function onLoseFocus()
						setColor(nil);
					end
				</script>
				<nodrag />
			</stringfield>
			

<!--ATTACK CALCS--><!--{{{-->
			<genericcontrol name="attackstepframe">
				<bounds>10,42,226,156</bounds>
				<frame>
					<name>modifier</name>
				</frame>
			</genericcontrol>
			<stringcontrol name="attacksteplabel">
				<anchored>
					<to>attackstepframe</to>
					<position>insidetop</position>
					<offset>-75,5</offset>
				</anchored>
				<font>sheetlabelsmallbold</font>
				<static>Attack Step:</static>
			</stringcontrol>
			
<!--attackbonusone--><!--{{{-->
			<nonlabeledstring name="attackbonusonesourcename"><!--{{{-->
				<bounds>20,55,140,20</bounds>
				<tabtarget>
					<prev>name</prev>
					<next>attribute</next>
				</tabtarget>
				<empty>Attack Source</empty>
				<script file="scripts/statmodifier.lua" />
				<script>
					localwidget = nil;
					function onDrop(x, y, draginfo)
						if draginfo.getType() == "string" then
							setValue(draginfo.getStringData());
							ret = setStep("attackbonusonestep");
							if ret ~= true then
								ret = grabTalentInfo("talents", "name", "attackbonusonestep", getValue());
							end
							if ret ~= true then
								ret = grabTalentInfo("skills", "name", "attackbonusonestep", getValue());
							end	
							if ret ~= true then
								ret = grabTalentInfo("spells", "name", "attackbonusonestep", getValue());
							end	
							if ret then
								window.attackbonusonestep.setReadOnly(true);
								localwidget.setVisible(true);
							else
								window.attackbonusonestep.setReadOnly(false);
								localwidget.setVisible(false);
							end
						end
						return true;
					end
					function onInit()
 						localwidget = addBitmapWidget("indicator_linked");
						localwidget.setPosition("left", -5, -3);
						localwidget.setVisible(false);
						ret = setStep("attackbonusonestep");
						if ret ~= true then
							ret = grabTalentInfo("talents", "name", "attackbonusonestep", getValue());
						end
						if ret ~= true then
							ret = grabTalentInfo("skills", "name", "attackbonusonestep", getValue());
						end	
						if ret ~= true then
							ret = grabTalentInfo("spells", "name", "attackbonusonestep", getValue());
						end	
						if ret then
							window.attackbonusonestep.setReadOnly(true);
							localwidget.setVisible(true);
						else
							window.attackbonusonestep.setReadOnly(false);
							localwidget.setVisible(false);
						end
					end
					function onLoseFocus()
						ret = setStep("attackbonusonestep");
						if ret ~= true then
							ret = grabTalentInfo("talents", "name", "attackbonusonestep", getValue());
						end
						if ret ~= true then
							ret = grabTalentInfo("skills", "name", "attackbonusonestep", getValue());
						end	
						if ret ~= true then
							ret = grabTalentInfo("spells", "name", "attackbonusonestep", getValue());
						end	
						if ret then
							window.attackbonusonestep.setReadOnly(true);
							localwidget.setVisible(true);
						else
							window.attackbonusonestep.setReadOnly(false);
							localwidget.setVisible(false);
						end
						
						super.onLoseFocus();
					end
				</script>
			</nonlabeledstring><!--}}}-->

			<numberfield name="attackbonusonestep"><!--{{{-->
				<bounds>165,53,25,20</bounds>
				<tabtarget>
					<prev>attribname</prev>
					<next>rank</next>
				</tabtarget>
				<font>sheettextsmall</font>
				<frame>
					<name>textline</name>
					<offset>0,-1,0,1</offset>
				</frame>
				<script>
					function onGainFocus()
						setColor("#FF990099");
					end
					
					function onLoseFocus()
						setColor(nil);
					end
					function onHover(state)
						if state then
							setColor("#FF990099");
						else
							if hasFocus() == false then
								setColor(nil);
							end
						end
					end
				</script>
			</numberfield><!--}}}-->
<!--}}}-->

<!--attackbonustwo--><!--{{{-->
			<nonlabeledstring name="attackbonustwosourcename"><!--{{{-->
				<bounds>20,75,140,20</bounds>
				<tabtarget>
					<prev>name</prev>
					<next>attribute</next>
				</tabtarget>
				<empty>Attack Source</empty>
				<script file="scripts/statmodifier.lua" />
				<script>
					localwidget = nil;
					function onDrop(x, y, draginfo)
						if draginfo.getType() == "string" then
							setValue(draginfo.getStringData());
							ret = setStep("attackbonustwostep");
							if ret ~= true then
								ret = grabTalentInfo("talents", "name", "attackbonustwostep", getValue());
							end
							if ret ~= true then
								ret = grabTalentInfo("skills", "name", "attackbonustwostep", getValue());
							end	
							if ret ~= true then
								ret = grabTalentInfo("spells", "name", "attackbonustwostep", getValue());
							end	
							if ret then
								window.attackbonustwostep.setReadOnly(true);
								localwidget.setVisible(true);
							else
								window.attackbonustwostep.setReadOnly(false);
								localwidget.setVisible(false);
							end
						end
						return true;
					end
					function onInit()
 						localwidget = addBitmapWidget("indicator_linked");
						localwidget.setPosition("left", -5, -3);
						localwidget.setVisible(false);
						ret = setStep("attackbonustwostep");
						if ret ~= true then
							ret = grabTalentInfo("talents", "name", "attackbonustwostep", getValue());
						end
						if ret ~= true then
							ret = grabTalentInfo("skills", "name", "attackbonustwostep", getValue());
						end	
						if ret ~= true then
							ret = grabTalentInfo("spells", "name", "attackbonustwostep", getValue());
						end	
						if ret then
							window.attackbonustwostep.setReadOnly(true);
							localwidget.setVisible(true);
						else
							window.attackbonustwostep.setReadOnly(false);
							localwidget.setVisible(false);
						end
					end
					function onLoseFocus()
						ret = setStep("attackbonustwostep");
						if ret ~= true then
							ret = grabTalentInfo("talents", "name", "attackbonustwostep", getValue());
						end
						if ret ~= true then
							ret = grabTalentInfo("skills", "name", "attackbonustwostep", getValue());
						end	
						if ret ~= true then
							ret = grabTalentInfo("spells", "name", "attackbonustwostep", getValue());
						end	
						if ret then
							window.attackbonustwostep.setReadOnly(true);
							localwidget.setVisible(true);
						else
							window.attackbonustwostep.setReadOnly(false);
							localwidget.setVisible(false);
						end
						
						super.onLoseFocus();
					end
				</script>
			</nonlabeledstring><!--}}}-->

			<numberfield name="attackbonustwostep"><!--{{{-->
				<bounds>165,73,25,20</bounds>
				<tabtarget>
					<prev>attribname</prev>
					<next>rank</next>
				</tabtarget>
				<font>sheettextsmall</font>
				<frame>
					<name>textline</name>
					<offset>0,-1,0,1</offset>
				</frame>
				<script>
					function onGainFocus()
						setColor("#FF990099");
					end
					
					function onLoseFocus()
						setColor(nil);
					end
					function onHover(state)
						if state then
							setColor("#FF990099");
						else
							if hasFocus() == false then
								setColor(nil);
							end
						end
					end
				</script>
			</numberfield><!--}}}-->
<!--}}}-->

<!--attackbonusthree--><!--{{{-->
			<nonlabeledstring name="attackbonusthreesourcename"><!--{{{-->
				<bounds>20,95,140,20</bounds>
				<tabtarget>
					<prev>name</prev>
					<next>attribute</next>
				</tabtarget>
				<empty>Attack Source</empty>
				<script file="scripts/statmodifier.lua" />
				<script>
					localwidget = nil;
					function onDrop(x, y, draginfo)
						if draginfo.getType() == "string" then
							setValue(draginfo.getStringData());
							ret = setStep("attackbonusthreestep");
							if ret ~= true then
								ret = grabTalentInfo("talents", "name", "attackbonusthreestep", getValue());
							end
							if ret ~= true then
								ret = grabTalentInfo("skills", "name", "attackbonusthreestep", getValue());
							end	
							if ret ~= true then
								ret = grabTalentInfo("spells", "name", "attackbonusthreestep", getValue());
							end	
							if ret then
								window.attackbonusthreestep.setReadOnly(true);
								localwidget.setVisible(true);
							else
								window.attackbonusthreestep.setReadOnly(false);
								localwidget.setVisible(false);
							end
						end
						return true;
					end
					function onInit()
 						localwidget = addBitmapWidget("indicator_linked");
						localwidget.setPosition("left", -5, -3);
						localwidget.setVisible(false);
						ret = setStep("attackbonusthreestep");
						if ret ~= true then
							ret = grabTalentInfo("talents", "name", "attackbonusthreestep", getValue());
						end
						if ret ~= true then
							ret = grabTalentInfo("skills", "name", "attackbonusthreestep", getValue());
						end	
						if ret ~= true then
							ret = grabTalentInfo("spells", "name", "attackbonusthreestep", getValue());
						end	
						if ret then
							window.attackbonusthreestep.setReadOnly(true);
							localwidget.setVisible(true);
						else
							window.attackbonusthreestep.setReadOnly(false);
							localwidget.setVisible(false);
						end
					end
					function onLoseFocus()
						ret = setStep("attackbonusthreestep");
						if ret ~= true then
							ret = grabTalentInfo("talents", "name", "attackbonusthreestep", getValue());
						end
						if ret ~= true then
							ret = grabTalentInfo("skills", "name", "attackbonusthreestep", getValue());
						end	
						if ret ~= true then
							ret = grabTalentInfo("spells", "name", "attackbonusthreestep", getValue());
						end	
						if ret then
							window.attackbonusthreestep.setReadOnly(true);
							localwidget.setVisible(true);
						else
							window.attackbonusthreestep.setReadOnly(false);
							localwidget.setVisible(false);
						end
						
						super.onLoseFocus();
					end
				</script>
			</nonlabeledstring><!--}}}-->

			<numberfield name="attackbonusthreestep"><!--{{{-->
				<bounds>165,93,25,20</bounds>
				<tabtarget>
					<prev>attribname</prev>
					<next>rank</next>
				</tabtarget>
				<font>sheettextsmall</font>
				<frame>
					<name>textline</name>
					<offset>0,-1,0,1</offset>
				</frame>
				<script>
					function onGainFocus()
						setColor("#FF990099");
					end
					
					function onLoseFocus()
						setColor(nil);
					end
					function onHover(state)
						if state then
							setColor("#FF990099");
						else
							if hasFocus() == false then
								setColor(nil);
							end
						end
					end
				</script>
			</numberfield><!--}}}-->
<!--}}}-->
<!--attackbonusfour--><!--{{{-->
			<nonlabeledstring name="attackbonusfoursourcename"><!--{{{-->
				<bounds>20,115,140,20</bounds>
				<tabtarget>
					<prev>name</prev>
					<next>attribute</next>
				</tabtarget>
				<empty>Attack Source</empty>
				<script file="scripts/statmodifier.lua" />
				<script>
					localwidget = nil;
					function onDrop(x, y, draginfo)
						if draginfo.getType() == "string" then
							setValue(draginfo.getStringData());
							ret = setStep("attackbonusfourstep");
							if ret ~= true then
								ret = grabTalentInfo("talents", "name", "attackbonusfourstep", getValue());
							end
							if ret ~= true then
								ret = grabTalentInfo("skills", "name", "attackbonusfourstep", getValue());
							end	
							if ret ~= true then
								ret = grabTalentInfo("spells", "name", "attackbonusfourstep", getValue());
							end	
							if ret then
								window.attackbonusfourstep.setReadOnly(true);
								localwidget.setVisible(true);
							else
								window.attackbonusfourstep.setReadOnly(false);
								localwidget.setVisible(false);
							end
						end
						return true;
					end
					function onInit()
 						localwidget = addBitmapWidget("indicator_linked");
						localwidget.setPosition("left", -5, -3);
						localwidget.setVisible(false);
						ret = setStep("attackbonusfourstep");
						if ret ~= true then
							ret = grabTalentInfo("talents", "name", "attackbonusfourstep", getValue());
						end
						if ret ~= true then
							ret = grabTalentInfo("skills", "name", "attackbonusfourstep", getValue());
						end	
						if ret ~= true then
							ret = grabTalentInfo("spells", "name", "attackbonusfourstep", getValue());
						end	
						if ret then
							window.attackbonusfourstep.setReadOnly(true);
							localwidget.setVisible(true);
						else
							window.attackbonusfourstep.setReadOnly(false);
							localwidget.setVisible(false);
						end
					end
					function onLoseFocus()
						ret = setStep("attackbonusfourstep");
						if ret ~= true then
							ret = grabTalentInfo("talents", "name", "attackbonusfourstep", getValue());
						end
						if ret ~= true then
							ret = grabTalentInfo("skills", "name", "attackbonusfourstep", getValue());
						end	
						if ret ~= true then
							ret = grabTalentInfo("spells", "name", "attackbonusfourstep", getValue());
						end	
						if ret then
							window.attackbonusfourstep.setReadOnly(true);
							localwidget.setVisible(true);
						else
							window.attackbonusfourstep.setReadOnly(false);
							localwidget.setVisible(false);
						end
						
						super.onLoseFocus();
					end
				</script>
			</nonlabeledstring><!--}}}-->

			<numberfield name="attackbonusfourstep"><!--{{{-->
				<bounds>165,113,25,20</bounds>
				<tabtarget>
					<prev>attribname</prev>
					<next>rank</next>
				</tabtarget>
				<font>sheettextsmall</font>
				<frame>
					<name>textline</name>
					<offset>0,-1,0,1</offset>
				</frame>
				<script>
					function onGainFocus()
						setColor("#FF990099");
					end
					
					function onLoseFocus()
						setColor(nil);
					end
					function onHover(state)
						if state then
							setColor("#FF990099");
						else
							if hasFocus() == false then
								setColor(nil);
							end
						end
					end
				</script>
			</numberfield><!--}}}-->
<!--}}}-->
<!--attackbonusfive--><!--{{{-->
			<nonlabeledstring name="attackbonusfivesourcename"><!--{{{-->
				<bounds>20,135,140,20</bounds>
				<tabtarget>
					<prev>name</prev>
					<next>attribute</next>
				</tabtarget>
				<empty>Attack Source</empty>
				<script file="scripts/statmodifier.lua" />
				<script>
					localwidget = nil;
					function onDrop(x, y, draginfo)
						if draginfo.getType() == "string" then
							setValue(draginfo.getStringData());
							ret = setStep("attackbonusfivestep");
							if ret ~= true then
								ret = grabTalentInfo("talents", "name", "attackbonusfivestep", getValue());
							end
							if ret ~= true then
								ret = grabTalentInfo("skills", "name", "attackbonusfivestep", getValue());
							end	
							if ret ~= true then
								ret = grabTalentInfo("spells", "name", "attackbonusfivestep", getValue());
							end	
							if ret then
								window.attackbonusfivestep.setReadOnly(true);
								localwidget.setVisible(true);
							else
								window.attackbonusfivestep.setReadOnly(false);
								localwidget.setVisible(false);
							end
						end
						return true;
					end
					function onInit()
 						localwidget = addBitmapWidget("indicator_linked");
						localwidget.setPosition("left", -5, -3);
						localwidget.setVisible(false);
						ret = setStep("attackbonusfivestep");
						if ret ~= true then
							ret = grabTalentInfo("talents", "name", "attackbonusfivestep", getValue());
						end
						if ret ~= true then
							ret = grabTalentInfo("skills", "name", "attackbonusfivestep", getValue());
						end	
						if ret ~= true then
							ret = grabTalentInfo("spells", "name", "attackbonusfivestep", getValue());
						end	
						if ret then
							window.attackbonusfivestep.setReadOnly(true);
							localwidget.setVisible(true);
						else
							window.attackbonusfivestep.setReadOnly(false);
							localwidget.setVisible(false);
						end
					end
					function onLoseFocus()
						ret = setStep("attackbonusfivestep");
						if ret ~= true then
							ret = grabTalentInfo("talents", "name", "attackbonusfivestep", getValue());
						end
						if ret ~= true then
							ret = grabTalentInfo("skills", "name", "attackbonusfivestep", getValue());
						end	
						if ret ~= true then
							ret = grabTalentInfo("spells", "name", "attackbonusfivestep", getValue());
						end	
						if ret then
							window.attackbonusfivestep.setReadOnly(true);
							localwidget.setVisible(true);
						else
							window.attackbonusfivestep.setReadOnly(false);
							localwidget.setVisible(false);
						end
						
						super.onLoseFocus();
					end
				</script>
			</nonlabeledstring><!--}}}-->

			<numberfield name="attackbonusfivestep"><!--{{{-->
				<bounds>165,133,25,20</bounds>
				<tabtarget>
					<prev>attribname</prev>
					<next>rank</next>
				</tabtarget>
				<font>sheettextsmall</font>
				<frame>
					<name>textline</name>
					<offset>0,-1,0,1</offset>
				</frame>
				<script>
					function onGainFocus()
						setColor("#FF990099");
					end
					
					function onLoseFocus()
						setColor(nil);
					end
					function onHover(state)
						if state then
							setColor("#FF990099");
						else
							if hasFocus() == false then
								setColor(nil);
							end
						end
					end
				</script>
			</numberfield><!--}}}-->
<!--}}}-->
<!--attackbonussix--><!--{{{-->
			<nonlabeledstring name="attackbonussixsourcename"><!--{{{-->
				<bounds>20,155,140,20</bounds>
				<tabtarget>
					<prev>name</prev>
					<next>attribute</next>
				</tabtarget>
				<empty>Attack Source</empty>
				<script file="scripts/statmodifier.lua" />
				<script>
					localwidget = nil;
					function onDrop(x, y, draginfo)
						if draginfo.getType() == "string" then
							setValue(draginfo.getStringData());
							ret = setStep("attackbonussixstep");
							if ret ~= true then
								ret = grabTalentInfo("talents", "name", "attackbonussixstep", getValue());
							end
							if ret ~= true then
								ret = grabTalentInfo("skills", "name", "attackbonussixstep", getValue());
							end	
							if ret ~= true then
								ret = grabTalentInfo("spells", "name", "attackbonussixstep", getValue());
							end	
							if ret then
								window.attackbonussixstep.setReadOnly(true);
								localwidget.setVisible(true);
							else
								window.attackbonussixstep.setReadOnly(false);
								localwidget.setVisible(false);
							end
						end
						return true;
					end
					function onInit()
 						localwidget = addBitmapWidget("indicator_linked");
						localwidget.setPosition("left", -5, -3);
						localwidget.setVisible(false);
						ret = setStep("attackbonussixstep");
						if ret ~= true then
							ret = grabTalentInfo("talents", "name", "attackbonussixstep", getValue());
						end
						if ret ~= true then
							ret = grabTalentInfo("skills", "name", "attackbonussixstep", getValue());
						end	
						if ret ~= true then
							ret = grabTalentInfo("spells", "name", "attackbonussixstep", getValue());
						end	
						if ret then
							window.attackbonussixstep.setReadOnly(true);
							localwidget.setVisible(true);
						else
							window.attackbonussixstep.setReadOnly(false);
							localwidget.setVisible(false);
						end
					end
					function onLoseFocus()
						ret = setStep("attackbonussixstep");
						if ret ~= true then
							ret = grabTalentInfo("talents", "name", "attackbonussixstep", getValue());
						end
						if ret ~= true then
							ret = grabTalentInfo("skills", "name", "attackbonussixstep", getValue());
						end	
						if ret ~= true then
							ret = grabTalentInfo("spells", "name", "attackbonussixstep", getValue());
						end	
						if ret then
							window.attackbonussixstep.setReadOnly(true);
							localwidget.setVisible(true);
						else
							window.attackbonussixstep.setReadOnly(false);
							localwidget.setVisible(false);
						end
						
						super.onLoseFocus();
					end
				</script>
			</nonlabeledstring><!--}}}-->

			<numberfield name="attackbonussixstep"><!--{{{-->
				<bounds>165,153,25,20</bounds>
				<tabtarget>
					<prev>attribname</prev>
					<next>rank</next>
				</tabtarget>
				<font>sheettextsmall</font>
				<frame>
					<name>textline</name>
					<offset>0,-1,0,1</offset>
				</frame>
				<script>
					function onGainFocus()
						setColor("#FF990099");
					end
					
					function onLoseFocus()
						setColor(nil);
					end
					function onHover(state)
						if state then
							setColor("#FF990099");
						else
							if hasFocus() == false then
								setColor(nil);
							end
						end
					end
				</script>
			</numberfield><!--}}}-->
<!--}}}-->
<!--attackbonusseven--><!--{{{-->
			<nonlabeledstring name="attackbonussevensourcename"><!--{{{-->
				<bounds>20,175,140,20</bounds>
				<tabtarget>
					<prev>name</prev>
					<next>attribute</next>
				</tabtarget>
				<empty>Attack Source</empty>
				<script file="scripts/statmodifier.lua" />
				<script>
					localwidget = nil;
					function onDrop(x, y, draginfo)
						if draginfo.getType() == "string" then
							setValue(draginfo.getStringData());
							ret = setStep("attackbonussevenstep");
							if ret ~= true then
								ret = grabTalentInfo("talents", "name", "attackbonussevenstep", getValue());
							end
							if ret ~= true then
								ret = grabTalentInfo("skills", "name", "attackbonussevenstep", getValue());
							end	
							if ret ~= true then
								ret = grabTalentInfo("spells", "name", "attackbonussevenstep", getValue());
							end	
							if ret then
								window.attackbonussevenstep.setReadOnly(true);
								localwidget.setVisible(true);
							else
								window.attackbonussevenstep.setReadOnly(false);
								localwidget.setVisible(false);
							end
						end
						return true;
					end
					function onInit()
 						localwidget = addBitmapWidget("indicator_linked");
						localwidget.setPosition("left", -5, -3);
						localwidget.setVisible(false);
						ret = setStep("attackbonussevenstep");
						if ret ~= true then
							ret = grabTalentInfo("talents", "name", "attackbonussevenstep", getValue());
						end
						if ret ~= true then
							ret = grabTalentInfo("skills", "name", "attackbonussevenstep", getValue());
						end	
						if ret ~= true then
							ret = grabTalentInfo("spells", "name", "attackbonussevenstep", getValue());
						end	
						if ret then
							window.attackbonussevenstep.setReadOnly(true);
							localwidget.setVisible(true);
						else
							window.attackbonussevenstep.setReadOnly(false);
							localwidget.setVisible(false);
						end
					end
					function onLoseFocus()
						ret = setStep("attackbonussevenstep");
						if ret ~= true then
							ret = grabTalentInfo("talents", "name", "attackbonussevenstep", getValue());
						end
						if ret ~= true then
							ret = grabTalentInfo("skills", "name", "attackbonussevenstep", getValue());
						end	
						if ret ~= true then
							ret = grabTalentInfo("spells", "name", "attackbonussevenstep", getValue());
						end	
						if ret then
							window.attackbonussevenstep.setReadOnly(true);
							localwidget.setVisible(true);
						else
							window.attackbonussevenstep.setReadOnly(false);
							localwidget.setVisible(false);
						end
						
						super.onLoseFocus();
					end
				</script>
			</nonlabeledstring><!--}}}-->

			<numberfield name="attackbonussevenstep"><!--{{{-->
				<bounds>165,173,25,20</bounds>
				<tabtarget>
					<prev>attribname</prev>
					<next>rank</next>
				</tabtarget>
				<font>sheettextsmall</font>
				<frame>
					<name>textline</name>
					<offset>0,-1,0,1</offset>
				</frame>
				<script>
					function onGainFocus()
						setColor("#FF990099");
					end
					
					function onLoseFocus()
						setColor(nil);
					end
					function onHover(state)
						if state then
							setColor("#FF990099");
						else
							if hasFocus() == false then
								setColor(nil);
							end
						end
					end
				</script>
			</numberfield><!--}}}-->
<!--}}}-->

<!--ATTACK STEP--><!--{{{-->
			<stringcontrol name="karmaonattacklabel">
				<bounds>195,47,75,20</bounds>
				<font>sheetlabelsmall</font>
				<static>Karma:</static>
				<invisible />
			</stringcontrol>
			<checkbox name="karmaonattackvis">
				<invisible />
				<bounds>198,52,25,25</bounds>
			</checkbox>
			<checkbox name="karmaonattack">
				<invisible />
				<disabled />
				<checked />
				<bounds>198,52,25,25</bounds>
				<script>
					function onValueChanged()
						window.karmaonattackvis.setState(window.karmaonattack.isVisible());
					end
				</script>
			</checkbox>

			<stringcontrol name="attacksteplabel">
				<bounds>193,70,75,20</bounds>
				<font>sheetlabelinline</font>
				<static>ATTACK</static>
			</stringcontrol>

			<stringfield name="attackkarmaclass" source="attackkarmaclass">
				<invisible />
				<bounds>193,70,75,20</bounds>
			</stringfield>

			<modifiernumber name="attackstep" source="attackstep.total">
				<bounds>199,80,25,25</bounds>

				<frame>
					<name>modifier</name>
					<offset>3,3,3,3</offset>
				</frame>
				<font>sheetnumber</font>
				<readonly />
				<source>
					<name>attackbonusonestep</name>
					<op>+</op>
				</source>
				<source>
					<name>attackbonustwostep</name>
					<op>+</op>
				</source>
				<source>
					<name>attackbonusthreestep</name>
					<op>+</op>
				</source>
				<source>
					<name>attackbonusfourstep</name>
					<op>+</op>
				</source>
				<source>
					<name>attackbonusfivestep</name>
					<op>+</op>
				</source>
				<source>
					<name>attackbonussixstep</name>
					<op>+</op>
				</source>
				<source>
					<name>attackbonussevenstep</name>
					<op>+</op>
				</source>
				<modifierfield>attackstep.total.temp</modifierfield>
				<modifierloc>bottomright</modifierloc>
				<script>
					function onDrag(button,x,y,dragdata)
						dragdata.setType("dice");
						dragdata.setSlot(1);
						dice = {};
						mod = 0;
						dice, mod = Step.getStepDice(getValue());
						dragdata.setDieList(dice);
						dragdata.setDescription(window.name.getValue() .. " (Attack Step " .. getValue() .. ")" );
						dragdata.setNumberData(mod);
						
						return true;
					end	
					function onDoubleClick()
						dice = {};
						mod = 0;
						dice, mod = Step.getStepDice(getValue());

						attackkarmastep = 0;
						karmaaddedtext = "";

						if window.karmaonattack.isVisible() and window.karmaonattack.getState() then
							--[[print("need to grab karma die for" .. window.attackkarmaclass.getValue());]]
							local node = window.getDatabaseNode().getParent().getParent();
							local source = node.getChild("discipline");
							local templist = source.getChildren();
							found = 0;
							attackkarmastep = 0;
							for i in pairs(templist) do
								if templist[i].getChild("name") then
									local discname = templist[i].getChild("name").getValue();
									if discname == window.attackkarmaclass.getValue() and found == 0 and templist[i].getChild("curr").getValue() &gt;= 1 then
										found = 1;
										attackkarmastep = templist[i].getChild("kstep").getValue();
										templist[i].getChild("curr").setValue(templist[i].getChild("curr").getValue() - 1);
										karmaaddedtext = " + Step " .. attackkarmastep .. " " .. window.attackkarmaclass.getValue() .. " Karma";
										
									end
								end
							end
							if attackkarmastep &gt;= 1 then
								dicea = {};
								dicea, mod = Step.getStepDice(attackkarmastep);
								for k,v in pairs(dicea) do 
									table.insert(dice, v) 
								end
							end
						end
						if window.strainonattack.getState() == true then
							window.attackstrain.onDoubleClick();
						end
						ChatManager.control.throwDice("dice",dice, mod, window.name.getValue() .. " (Attack Step " .. getValue() .. karmaaddedtext .. ")");
					end
					function onHover(state)
						if state then
							setColor("#FF228822");
							setFrame("sheetfocus", 3, 3, 3, 3);
						else
							if hasFocus() == false then
								setColor(nil);
								setFrame("modifier", 3, 3, 3, 3);
							end
						end
					end
				</script>
			</modifiernumber>
			<stringcontrol name="steplabel">
				<bounds>200,103,75,20</bounds>
				<font>sheetlabelinline</font>
				<static>STEP</static>
			</stringcontrol>
<!--}}}-->

<!--}}}-->

<!--DAMAGE CALCS--><!--{{{-->
			<genericcontrol name="damagestepframe">
				<bounds>236,42,226,156</bounds>
				<frame>
					<name>modifier</name>
				</frame>
			</genericcontrol>
			<stringcontrol name="damagesteplabel">
				<anchored>
					<to>damagestepframe</to>
					<position>insidetop</position>
					<offset>-75,5</offset>
				</anchored>
				<font>sheetlabelsmallbold</font>
				<static>Damage Step:</static>
			</stringcontrol>
			
<!--damagebonusone--><!--{{{-->
			<nonlabeledstring name="damagebonusonesourcename"><!--{{{-->
				<!-- <bounds>20,55,140,20</bounds> -->
				<bounds>246,55,140,20</bounds>
				<tabtarget>
					<prev>name</prev>
					<next>attribute</next>
				</tabtarget>
				<empty>Damage Source</empty>
				<script file="scripts/statmodifier.lua" />
				<script>
					localwidget = nil;
					function onDrop(x, y, draginfo)
						if draginfo.getType() == "string" then
							setValue(draginfo.getStringData());
							ret = setStep("damagebonusonestep");
							if ret ~= true then
								ret = grabTalentInfo("talents", "name", "damagebonusonestep", getValue());
							end
							if ret ~= true then
								ret = grabTalentInfo("skills", "name", "damagebonusonestep", getValue());
							end	
							if ret ~= true then
								ret = grabTalentInfo("spells", "name", "damagebonusonestep", getValue());
							end	
							if ret then
								window.damagebonusonestep.setReadOnly(true);
								localwidget.setVisible(true);
							else
								window.damagebonusonestep.setReadOnly(false);
								localwidget.setVisible(false);
							end
						end
						return true;
					end
					function onInit()
 						localwidget = addBitmapWidget("indicator_linked");
						localwidget.setPosition("left", -5, -3);
						localwidget.setVisible(false);
						ret = setStep("damagebonusonestep");
						if ret ~= true then
							ret = grabTalentInfo("talents", "name", "damagebonusonestep", getValue());
						end
						if ret ~= true then
							ret = grabTalentInfo("skills", "name", "damagebonusonestep", getValue());
						end	
						if ret ~= true then
							ret = grabTalentInfo("spells", "name", "damagebonusonestep", getValue());
						end	
						if ret then
							window.damagebonusonestep.setReadOnly(true);
							localwidget.setVisible(true);
						else
							window.damagebonusonestep.setReadOnly(false);
							localwidget.setVisible(false);
						end
					end
					function onLoseFocus()
						ret = setStep("damagebonusonestep");
						if ret ~= true then
							ret = grabTalentInfo("talents", "name", "damagebonusonestep", getValue());
						end
						if ret ~= true then
							ret = grabTalentInfo("skills", "name", "damagebonusonestep", getValue());
						end	
						if ret ~= true then
							ret = grabTalentInfo("spells", "name", "damagebonusonestep", getValue());
						end	
						if ret then
							window.damagebonusonestep.setReadOnly(true);
							localwidget.setVisible(true);
						else
							window.damagebonusonestep.setReadOnly(false);
							localwidget.setVisible(false);
						end
						
						super.onLoseFocus();
					end
				</script>
			</nonlabeledstring><!--}}}-->

			<numberfield name="damagebonusonestep"><!--{{{-->
				<!--<bounds>165,53,25,20</bounds>-->
				<bounds>391,53,25,20</bounds>
				<tabtarget>
					<prev>attribname</prev>
					<next>rank</next>
				</tabtarget>
				<font>sheettextsmall</font>
				<frame>
					<name>textline</name>
					<offset>0,-1,0,1</offset>
				</frame>
				<script>
					function onGainFocus()
						setColor("#FF990099");
					end
					
					function onLoseFocus()
						setColor(nil);
					end
					function onHover(state)
						if state then
							setColor("#FF990099");
						else
							if hasFocus() == false then
								setColor(nil);
							end
						end
					end
				</script>
			</numberfield><!--}}}-->
<!--}}}-->

<!--damagebonustwo--><!--{{{-->
			<nonlabeledstring name="damagebonustwosourcename"><!--{{{-->
				<!--<bounds>20,75,140,20</bounds>-->
				<bounds>246,75,140,20</bounds>
				<tabtarget>
					<prev>name</prev>
					<next>attribute</next>
				</tabtarget>
				<empty>Damage Source</empty>
				<script file="scripts/statmodifier.lua" />
				<script>
					localwidget = nil;
					function onDrop(x, y, draginfo)
						if draginfo.getType() == "string" then
							setValue(draginfo.getStringData());
							ret = setStep("damagebonustwostep");
							if ret ~= true then
								ret = grabTalentInfo("talents", "name", "damagebonustwostep", getValue());
							end
							if ret ~= true then
								ret = grabTalentInfo("skills", "name", "damagebonustwostep", getValue());
							end	
							if ret ~= true then
								ret = grabTalentInfo("spells", "name", "damagebonustwostep", getValue());
							end	
							if ret then
								window.damagebonustwostep.setReadOnly(true);
								localwidget.setVisible(true);
							else
								window.damagebonustwostep.setReadOnly(false);
								localwidget.setVisible(false);
							end
						end
						return true;
					end
					function onInit()
 						localwidget = addBitmapWidget("indicator_linked");
						localwidget.setPosition("left", -5, -3);
						localwidget.setVisible(false);
						ret = setStep("damagebonustwostep");
						if ret ~= true then
							ret = grabTalentInfo("talents", "name", "damagebonustwostep", getValue());
						end
						if ret ~= true then
							ret = grabTalentInfo("skills", "name", "damagebonustwostep", getValue());
						end	
						if ret ~= true then
							ret = grabTalentInfo("spells", "name", "damagebonustwostep", getValue());
						end	
						if ret then
							window.damagebonustwostep.setReadOnly(true);
							localwidget.setVisible(true);
						else
							window.damagebonustwostep.setReadOnly(false);
							localwidget.setVisible(false);
						end
					end
					function onLoseFocus()
						ret = setStep("damagebonustwostep");
						if ret ~= true then
							ret = grabTalentInfo("talents", "name", "damagebonustwostep", getValue());
						end
						if ret ~= true then
							ret = grabTalentInfo("skills", "name", "damagebonustwostep", getValue());
						end	
						if ret ~= true then
							ret = grabTalentInfo("spells", "name", "damagebonustwostep", getValue());
						end	
						if ret then
							window.damagebonustwostep.setReadOnly(true);
							localwidget.setVisible(true);
						else
							window.damagebonustwostep.setReadOnly(false);
							localwidget.setVisible(false);
						end
						
						super.onLoseFocus();
					end
				</script>
			</nonlabeledstring><!--}}}-->

			<numberfield name="damagebonustwostep"><!--{{{-->
				<!--<bounds>165,73,25,20</bounds>-->
				<bounds>391,73,25,20</bounds>
				<tabtarget>
					<prev>attribname</prev>
					<next>rank</next>
				</tabtarget>
				<font>sheettextsmall</font>
				<frame>
					<name>textline</name>
					<offset>0,-1,0,1</offset>
				</frame>
				<script>
					function onGainFocus()
						setColor("#FF990099");
					end
					
					function onLoseFocus()
						setColor(nil);
					end
					function onHover(state)
						if state then
							setColor("#FF990099");
						else
							if hasFocus() == false then
								setColor(nil);
							end
						end
					end
				</script>
			</numberfield><!--}}}-->
<!--}}}-->

<!--damagebonusthree--><!--{{{-->
			<nonlabeledstring name="damagebonusthreesourcename"><!--{{{-->
				<!--<bounds>20,95,140,20</bounds> -->
				<bounds>246,95,140,20</bounds>
				<tabtarget>
					<prev>name</prev>
					<next>attribute</next>
				</tabtarget>
				<empty>Damage Source</empty>
				<script file="scripts/statmodifier.lua" />
				<script>
					localwidget = nil;
					function onDrop(x, y, draginfo)
						if draginfo.getType() == "string" then
							setValue(draginfo.getStringData());
							ret = setStep("damagebonusthreestep");
							if ret ~= true then
								ret = grabTalentInfo("talents", "name", "damagebonusthreestep", getValue());
							end
							if ret ~= true then
								ret = grabTalentInfo("skills", "name", "damagebonusthreestep", getValue());
							end	
							if ret ~= true then
								ret = grabTalentInfo("spells", "name", "damagebonusthreestep", getValue());
							end	
							if ret then
								window.damagebonusthreestep.setReadOnly(true);
								localwidget.setVisible(true);
							else
								window.damagebonusthreestep.setReadOnly(false);
								localwidget.setVisible(false);
							end
						end
						return true;
					end
					function onInit()
 						localwidget = addBitmapWidget("indicator_linked");
						localwidget.setPosition("left", -5, -3);
						localwidget.setVisible(false);
						ret = setStep("damagebonusthreestep");
						if ret ~= true then
							ret = grabTalentInfo("talents", "name", "damagebonusthreestep", getValue());
						end
						if ret ~= true then
							ret = grabTalentInfo("skills", "name", "damagebonusthreestep", getValue());
						end	
						if ret ~= true then
							ret = grabTalentInfo("spells", "name", "damagebonusthreestep", getValue());
						end	
						if ret then
							window.damagebonusthreestep.setReadOnly(true);
							localwidget.setVisible(true);
						else
							window.damagebonusthreestep.setReadOnly(false);
							localwidget.setVisible(false);
						end
					end
					function onLoseFocus()
						ret = setStep("damagebonusthreestep");
						if ret ~= true then
							ret = grabTalentInfo("talents", "name", "damagebonusthreestep", getValue());
						end
						if ret ~= true then
							ret = grabTalentInfo("skills", "name", "damagebonusthreestep", getValue());
						end	
						if ret ~= true then
							ret = grabTalentInfo("spells", "name", "damagebonusthreestep", getValue());
						end	
						if ret then
							window.damagebonusthreestep.setReadOnly(true);
							localwidget.setVisible(true);
						else
							window.damagebonusthreestep.setReadOnly(false);
							localwidget.setVisible(false);
						end
						
						super.onLoseFocus();
					end
				</script>
			</nonlabeledstring><!--}}}-->

			<numberfield name="damagebonusthreestep"><!--{{{-->
				<!--<bounds>165,93,25,20</bounds>-->
				<bounds>391,93,25,20</bounds>
				<tabtarget>
					<prev>attribname</prev>
					<next>rank</next>
				</tabtarget>
				<font>sheettextsmall</font>
				<frame>
					<name>textline</name>
					<offset>0,-1,0,1</offset>
				</frame>
				<script>
					function onGainFocus()
						setColor("#FF990099");
					end
					
					function onLoseFocus()
						setColor(nil);
					end
					function onHover(state)
						if state then
							setColor("#FF990099");
						else
							if hasFocus() == false then
								setColor(nil);
							end
						end
					end
				</script>
			</numberfield><!--}}}-->
<!--}}}-->
<!--damagebonusfour--><!--{{{-->
			<nonlabeledstring name="damagebonusfoursourcename"><!--{{{-->
				<!--<bounds>20,95,140,20</bounds> -->
				<bounds>246,115,140,20</bounds>
				<tabtarget>
					<prev>name</prev>
					<next>attribute</next>
				</tabtarget>
				<empty>Damage Source</empty>
				<script file="scripts/statmodifier.lua" />
				<script>
					localwidget = nil;
					function onDrop(x, y, draginfo)
						if draginfo.getType() == "string" then
							setValue(draginfo.getStringData());
							ret = setStep("damagebonusfourstep");
							if ret ~= true then
								ret = grabTalentInfo("talents", "name", "damagebonusfourstep", getValue());
							end
							if ret ~= true then
								ret = grabTalentInfo("skills", "name", "damagebonusfourstep", getValue());
							end	
							if ret ~= true then
								ret = grabTalentInfo("spells", "name", "damagebonusfourstep", getValue());
							end	
							if ret then
								window.damagebonusfourstep.setReadOnly(true);
								localwidget.setVisible(true);
							else
								window.damagebonusfourstep.setReadOnly(false);
								localwidget.setVisible(false);
							end
						end
						return true;
					end
					function onInit()
 						localwidget = addBitmapWidget("indicator_linked");
						localwidget.setPosition("left", -5, -3);
						localwidget.setVisible(false);
						ret = setStep("damagebonusfourstep");
						if ret ~= true then
							ret = grabTalentInfo("talents", "name", "damagebonusfourstep", getValue());
						end
						if ret ~= true then
							ret = grabTalentInfo("skills", "name", "damagebonusfourstep", getValue());
						end	
						if ret ~= true then
							ret = grabTalentInfo("spells", "name", "damagebonusfourstep", getValue());
						end	
						if ret then
							window.damagebonusfourstep.setReadOnly(true);
							localwidget.setVisible(true);
						else
							window.damagebonusfourstep.setReadOnly(false);
							localwidget.setVisible(false);
						end
					end
					function onLoseFocus()
						ret = setStep("damagebonusfourstep");
						if ret ~= true then
							ret = grabTalentInfo("talents", "name", "damagebonusfourstep", getValue());
						end
						if ret ~= true then
							ret = grabTalentInfo("skills", "name", "damagebonusfourstep", getValue());
						end	
						if ret ~= true then
							ret = grabTalentInfo("spells", "name", "damagebonusfourstep", getValue());
						end	
						if ret then
							window.damagebonusfourstep.setReadOnly(true);
							localwidget.setVisible(true);
						else
							window.damagebonusfourstep.setReadOnly(false);
							localwidget.setVisible(false);
						end
						
						super.onLoseFocus();
					end
				</script>
			</nonlabeledstring><!--}}}-->

			<numberfield name="damagebonusfourstep"><!--{{{-->
				<!--<bounds>165,93,25,20</bounds>-->
				<bounds>391,113,25,20</bounds>
				<tabtarget>
					<prev>attribname</prev>
					<next>rank</next>
				</tabtarget>
				<font>sheettextsmall</font>
				<frame>
					<name>textline</name>
					<offset>0,-1,0,1</offset>
				</frame>
				<script>
					function onGainFocus()
						setColor("#FF990099");
					end
					
					function onLoseFocus()
						setColor(nil);
					end
					function onHover(state)
						if state then
							setColor("#FF990099");
						else
							if hasFocus() == false then
								setColor(nil);
							end
						end
					end
				</script>
			</numberfield><!--}}}-->
<!--}}}-->
<!--damagebonusfive--><!--{{{-->
			<nonlabeledstring name="damagebonusfivesourcename"><!--{{{-->
				<!--<bounds>20,95,140,20</bounds> -->
				<bounds>246,135,140,20</bounds>
				<tabtarget>
					<prev>name</prev>
					<next>attribute</next>
				</tabtarget>
				<empty>Damage Source</empty>
				<script file="scripts/statmodifier.lua" />
				<script>
					localwidget = nil;
					function onDrop(x, y, draginfo)
						if draginfo.getType() == "string" then
							setValue(draginfo.getStringData());
							ret = setStep("damagebonusfivestep");
							if ret ~= true then
								ret = grabTalentInfo("talents", "name", "damagebonusfivestep", getValue());
							end
							if ret ~= true then
								ret = grabTalentInfo("skills", "name", "damagebonusfivestep", getValue());
							end	
							if ret ~= true then
								ret = grabTalentInfo("spells", "name", "damagebonusfivestep", getValue());
							end	
							if ret then
								window.damagebonusfivestep.setReadOnly(true);
								localwidget.setVisible(true);
							else
								window.damagebonusfivestep.setReadOnly(false);
								localwidget.setVisible(false);
							end
						end
						return true;
					end
					function onInit()
 						localwidget = addBitmapWidget("indicator_linked");
						localwidget.setPosition("left", -5, -3);
						localwidget.setVisible(false);
						ret = setStep("damagebonusfivestep");
						if ret ~= true then
							ret = grabTalentInfo("talents", "name", "damagebonusfivestep", getValue());
						end
						if ret ~= true then
							ret = grabTalentInfo("skills", "name", "damagebonusfivestep", getValue());
						end	
						if ret ~= true then
							ret = grabTalentInfo("spells", "name", "damagebonusfivestep", getValue());
						end	
						if ret then
							window.damagebonusfivestep.setReadOnly(true);
							localwidget.setVisible(true);
						else
							window.damagebonusfivestep.setReadOnly(false);
							localwidget.setVisible(false);
						end
					end
					function onLoseFocus()
						ret = setStep("damagebonusfivestep");
						if ret ~= true then
							ret = grabTalentInfo("talents", "name", "damagebonusfivestep", getValue());
						end
						if ret ~= true then
							ret = grabTalentInfo("skills", "name", "damagebonusfivestep", getValue());
						end	
						if ret ~= true then
							ret = grabTalentInfo("spells", "name", "damagebonusfivestep", getValue());
						end	
						if ret then
							window.damagebonusfivestep.setReadOnly(true);
							localwidget.setVisible(true);
						else
							window.damagebonusfivestep.setReadOnly(false);
							localwidget.setVisible(false);
						end
						
						super.onLoseFocus();
					end
				</script>
			</nonlabeledstring><!--}}}-->

			<numberfield name="damagebonusfivestep"><!--{{{-->
				<!--<bounds>165,93,25,20</bounds>-->
				<bounds>391,133,25,20</bounds>
				<tabtarget>
					<prev>attribname</prev>
					<next>rank</next>
				</tabtarget>
				<font>sheettextsmall</font>
				<frame>
					<name>textline</name>
					<offset>0,-1,0,1</offset>
				</frame>
				<script>
					function onGainFocus()
						setColor("#FF990099");
					end
					
					function onLoseFocus()
						setColor(nil);
					end
					function onHover(state)
						if state then
							setColor("#FF990099");
						else
							if hasFocus() == false then
								setColor(nil);
							end
						end
					end
				</script>
			</numberfield><!--}}}-->
<!--}}}-->
<!--damagebonussix--><!--{{{-->
			<nonlabeledstring name="damagebonussixsourcename"><!--{{{-->
				<!--<bounds>20,95,140,20</bounds> -->
				<bounds>246,155,140,20</bounds>
				<tabtarget>
					<prev>name</prev>
					<next>attribute</next>
				</tabtarget>
				<empty>Damage Source</empty>
				<script file="scripts/statmodifier.lua" />
				<script>
					localwidget = nil;
					function onDrop(x, y, draginfo)
						if draginfo.getType() == "string" then
							setValue(draginfo.getStringData());
							ret = setStep("damagebonussixstep");
							if ret ~= true then
								ret = grabTalentInfo("talents", "name", "damagebonussixstep", getValue());
							end
							if ret ~= true then
								ret = grabTalentInfo("skills", "name", "damagebonussixstep", getValue());
							end	
							if ret ~= true then
								ret = grabTalentInfo("spells", "name", "damagebonussixstep", getValue());
							end	
							if ret then
								window.damagebonussixstep.setReadOnly(true);
								localwidget.setVisible(true);
							else
								window.damagebonussixstep.setReadOnly(false);
								localwidget.setVisible(false);
							end
						end
						return true;
					end
					function onInit()
 						localwidget = addBitmapWidget("indicator_linked");
						localwidget.setPosition("left", -5, -3);
						localwidget.setVisible(false);
						ret = setStep("damagebonussixstep");
						if ret ~= true then
							ret = grabTalentInfo("talents", "name", "damagebonussixstep", getValue());
						end
						if ret ~= true then
							ret = grabTalentInfo("skills", "name", "damagebonussixstep", getValue());
						end	
						if ret ~= true then
							ret = grabTalentInfo("spells", "name", "damagebonussixstep", getValue());
						end	
						if ret then
							window.damagebonussixstep.setReadOnly(true);
							localwidget.setVisible(true);
						else
							window.damagebonussixstep.setReadOnly(false);
							localwidget.setVisible(false);
						end
					end
					function onLoseFocus()
						ret = setStep("damagebonussixstep");
						if ret ~= true then
							ret = grabTalentInfo("talents", "name", "damagebonussixstep", getValue());
						end
						if ret ~= true then
							ret = grabTalentInfo("skills", "name", "damagebonussixstep", getValue());
						end	
						if ret ~= true then
							ret = grabTalentInfo("spells", "name", "damagebonussixstep", getValue());
						end	
						if ret then
							window.damagebonussixstep.setReadOnly(true);
							localwidget.setVisible(true);
						else
							window.damagebonussixstep.setReadOnly(false);
							localwidget.setVisible(false);
						end
						
						super.onLoseFocus();
					end
				</script>
			</nonlabeledstring><!--}}}-->

			<numberfield name="damagebonussixstep"><!--{{{-->
				<!--<bounds>165,93,25,20</bounds>-->
				<bounds>391,153,25,20</bounds>
				<tabtarget>
					<prev>attribname</prev>
					<next>rank</next>
				</tabtarget>
				<font>sheettextsmall</font>
				<frame>
					<name>textline</name>
					<offset>0,-1,0,1</offset>
				</frame>
				<script>
					function onGainFocus()
						setColor("#FF990099");
					end
					
					function onLoseFocus()
						setColor(nil);
					end
					function onHover(state)
						if state then
							setColor("#FF990099");
						else
							if hasFocus() == false then
								setColor(nil);
							end
						end
					end
				</script>
			</numberfield><!--}}}-->
<!--}}}-->
<!--damagebonusseven--><!--{{{-->
			<nonlabeledstring name="damagebonussevensourcename"><!--{{{-->
				<!--<bounds>20,95,140,20</bounds> -->
				<bounds>246,175,140,20</bounds>
				<tabtarget>
					<prev>name</prev>
					<next>attribute</next>
				</tabtarget>
				<empty>Damage Source</empty>
				<script file="scripts/statmodifier.lua" />
				<script>
					localwidget = nil;
					function onDrop(x, y, draginfo)
						if draginfo.getType() == "string" then
							setValue(draginfo.getStringData());
							ret = setStep("damagebonussevenstep");
							if ret ~= true then
								ret = grabTalentInfo("talents", "name", "damagebonussevenstep", getValue());
							end
							if ret ~= true then
								ret = grabTalentInfo("skills", "name", "damagebonussevenstep", getValue());
							end	
							if ret ~= true then
								ret = grabTalentInfo("spells", "name", "damagebonussevenstep", getValue());
							end	
							if ret then
								window.damagebonussevenstep.setReadOnly(true);
								localwidget.setVisible(true);
							else
								window.damagebonussevenstep.setReadOnly(false);
								localwidget.setVisible(false);
							end
						end
						return true;
					end
					function onInit()
 						localwidget = addBitmapWidget("indicator_linked");
						localwidget.setPosition("left", -5, -3);
						localwidget.setVisible(false);
						ret = setStep("damagebonussevenstep");
						if ret ~= true then
							ret = grabTalentInfo("talents", "name", "damagebonussevenstep", getValue());
						end
						if ret ~= true then
							ret = grabTalentInfo("skills", "name", "damagebonussevenstep", getValue());
						end	
						if ret ~= true then
							ret = grabTalentInfo("spells", "name", "damagebonussevenstep", getValue());
						end	
						if ret then
							window.damagebonussevenstep.setReadOnly(true);
							localwidget.setVisible(true);
						else
							window.damagebonussevenstep.setReadOnly(false);
							localwidget.setVisible(false);
						end
					end
					function onLoseFocus()
						ret = setStep("damagebonussevenstep");
						if ret ~= true then
							ret = grabTalentInfo("talents", "name", "damagebonussevenstep", getValue());
						end
						if ret ~= true then
							ret = grabTalentInfo("skills", "name", "damagebonussevenstep", getValue());
						end	
						if ret ~= true then
							ret = grabTalentInfo("spells", "name", "damagebonussevenstep", getValue());
						end	
						if ret then
							window.damagebonussevenstep.setReadOnly(true);
							localwidget.setVisible(true);
						else
							window.damagebonussevenstep.setReadOnly(false);
							localwidget.setVisible(false);
						end
						
						super.onLoseFocus();
					end
				</script>
			</nonlabeledstring><!--}}}-->

			<numberfield name="damagebonussevenstep"><!--{{{-->
				<!--<bounds>165,93,25,20</bounds>-->
				<bounds>391,173,25,20</bounds>
				<tabtarget>
					<prev>attribname</prev>
					<next>rank</next>
				</tabtarget>
				<font>sheettextsmall</font>
				<frame>
					<name>textline</name>
					<offset>0,-1,0,1</offset>
				</frame>
				<script>
					function onGainFocus()
						setColor("#FF990099");
					end
					
					function onLoseFocus()
						setColor(nil);
					end
					function onHover(state)
						if state then
							setColor("#FF990099");
						else
							if hasFocus() == false then
								setColor(nil);
							end
						end
					end
				</script>
			</numberfield><!--}}}-->
<!--}}}-->

<!--DAMAGE STEP--><!--{{{-->
			<stringcontrol name="karmaondamagelabel">
				<!--<bounds>195,47,75,20</bounds>-->
				<bounds>421,47,75,20</bounds>
				<font>sheetlabelsmall</font>
				<static>Karma:</static>
				<invisible />
			</stringcontrol>
			<checkbox name="karmaondamagevis">
				<invisible />
				<!--<bounds>198,52,25,25</bounds>-->
				<bounds>424,52,25,25</bounds>
			</checkbox>
			<checkbox name="karmaondamage">
				<invisible />
				<disabled />
				<checked />
				<!--<bounds>198,52,25,25</bounds>-->
				<bounds>424,53,25,25</bounds>
				<script>
					function onValueChanged()
						window.karmaondamagevis.setState(window.karmaondamage.isVisible());
					end
				</script>
			</checkbox>

			<stringcontrol name="damagesteplabel">
				<!--<bounds>193,70,75,20</bounds>-->
				<bounds>417,70,75,20</bounds>
				<font>sheetlabelinline</font>
				<static>DAMAGE</static>
			</stringcontrol>

			<stringfield name="damagekarmaclass" source="damagekarmaclass">
				<invisible />
				<bounds>193,70,75,20</bounds>
			</stringfield>

			<modifiernumber name="damagestep" source="damagestep.total">
				<!--<bounds>199,80,25,25</bounds>-->
				<bounds>425,80,25,25</bounds>

				<frame>
					<name>modifier</name>
					<offset>3,3,3,3</offset>
				</frame>
				<font>sheetnumber</font>
				<readonly />
				<source>
					<name>damagebonusonestep</name>
					<op>+</op>
				</source>
				<source>
					<name>damagebonustwostep</name>
					<op>+</op>
				</source>
				<source>
					<name>damagebonusthreestep</name>
					<op>+</op>
				</source>
				<source>
					<name>damagebonusfourstep</name>
					<op>+</op>
				</source>
				<source>
					<name>damagebonusfivestep</name>
					<op>+</op>
				</source>
				<source>
					<name>damagebonussixstep</name>
					<op>+</op>
				</source>
				<source>
					<name>damagebonussevenstep</name>
					<op>+</op>
				</source>
				<modifierfield>damagestep.total.temp</modifierfield>
				<modifierloc>bottomright</modifierloc>
				<script>
					function onDrag(button,x,y,dragdata)
						dragdata.setType("dice");
						dragdata.setSlot(1);
						dice = {};
						mod = 0;
						dice, mod = Step.getStepDice(getValue());
						dragdata.setDieList(dice);
						dragdata.setDescription(window.name.getValue() .. " (Damage Step " .. getValue() .. ")" );
						dragdata.setNumberData(mod);
						
						return true;
					end	
					function onDoubleClick()
						dice = {};
						mod = 0;
						dice, mod = Step.getStepDice(getValue());

						damagekarmastep = 0;
						karmaaddedtext = "";

						if window.karmaondamage.isVisible() and window.karmaondamage.getState() then
							--[[print("need to grab karma die for" .. window.damagekarmaclass.getValue());]]
							local node = window.getDatabaseNode().getParent().getParent();
							local source = node.getChild("discipline");
							local templist = source.getChildren();
							found = 0;
							damagekarmastep = 0;
							for i in pairs(templist) do
								if templist[i].getChild("name") then
									local discname = templist[i].getChild("name").getValue();
									if discname == window.damagekarmaclass.getValue() and found == 0 and templist[i].getChild("curr").getValue() &gt;= 1 then
										found = 1;
										damagekarmastep = templist[i].getChild("kstep").getValue();
										templist[i].getChild("curr").setValue(templist[i].getChild("curr").getValue() - 1);
										karmaaddedtext = " + Step " .. damagekarmastep .. " " .. window.damagekarmaclass.getValue() .. " Karma";
										
									end
								end
							end
							if damagekarmastep &gt;= 1 then
								dicea = {};
								dicea, mod = Step.getStepDice(damagekarmastep);
								for k,v in pairs(dicea) do 
									table.insert(dice, v) 
								end
							end
						end
						if window.strainondamage.getState() == true then
							window.damagestrain.onDoubleClick();
						end
						ChatManager.control.throwDice("dice",dice, mod, window.name.getValue() .. " (Damage Step " .. getValue() .. karmaaddedtext .. ")");
					end
					function onHover(state)
						if state then
							setColor("#FF228822");
							setFrame("sheetfocus", 3, 3, 3, 3);
						else
							if hasFocus() == false then
								setColor(nil);
								setFrame("modifier", 3, 3, 3, 3);
							end
						end
					end
				</script>
			</modifiernumber>
			<stringcontrol name="steplabel">
				<!--<bounds>200,103,75,20</bounds>-->
				<bounds>426,103,75,20</bounds>
				<font>sheetlabelinline</font>
				<static>STEP</static>
			</stringcontrol>
<!--}}}-->


<!--}}}-->

<!--VS DEF--><!--{{{-->
			<genericcontrol name="defenseframe">
				<bounds>10,194,160,40</bounds>
				<frame>
					<name>modifier</name>
				</frame>
			</genericcontrol>
			<stringcontrol name="deflabel">
				<anchored>
					<to>defenseframe</to>
					<position>insidetop</position>
					<offset>-45,5</offset>
				</anchored>
				<font>sheetlabelsmallbold</font>
				<static>vs Defense:</static>
			</stringcontrol>


			<stringcontrol name="phydeflabel">
				<bounds>17,212,75,20</bounds>
				<font>sheetlabelsmall</font>
				<static>Physical:</static>
			</stringcontrol>
			<checkbox name="physicaldefense">
				<bounds>50,205,25,25</bounds>
			</checkbox>
			
			<stringcontrol name="spelldeflabel">
				<bounds>75,212,25,25</bounds>
				<font>sheetlabelsmall</font>
				<static>Spell:</static>
			</stringcontrol>
			<checkbox name="spelldefense">
				<bounds>98,205,25,25</bounds>
			</checkbox>
			
			<stringcontrol name="socialdeflabel">
				<bounds>120,212,25,25</bounds>
				<font>sheetlabelsmall</font>
				<static>Social:</static>
			</stringcontrol>
			<checkbox name="socialdefense">
				<bounds>143,205,25,25</bounds>
			</checkbox>
<!--}}}-->

<!--VS ARMOR--><!--{{{-->
			<genericcontrol name="armorframe">
				<bounds>10,234,160,40</bounds>
				<frame>
					<name>modifier</name>
				</frame>
			</genericcontrol>
			<stringcontrol name="armorlabel">
				<anchored>
					<to>armorframe</to>
					<position>insidetop</position>
					<offset>-45,5</offset>
				</anchored>
				<font>sheetlabelsmallbold</font>
				<static>vs Armor:</static>
			</stringcontrol>


			<stringcontrol name="phyarmorlabel">
				<bounds>17,252,75,20</bounds>
				<font>sheetlabelsmall</font>
				<static>Physical:</static>
			</stringcontrol>
			<checkbox name="physicalarmor">
				<bounds>50,245,25,25</bounds>
			</checkbox>
			
			<stringcontrol name="mysticarmorlabel">
				<bounds>75,252,30,25</bounds>
				<font>sheetlabelsmall</font>
				<static>Mystic:</static>
			</stringcontrol>
			<checkbox name="mysticarmor">
				<bounds>103,245,25,25</bounds>
			</checkbox>
			
<!--}}}-->

<!-- Strain --> <!--{{{-->
			<genericcontrol name="defenseframe">
				<bounds>167,194,69,80</bounds>
				<frame>
					<name>modifier</name>
				</frame>
			</genericcontrol>
			<stringcontrol name="strainlabel">
				<bounds>184,199,40,20</bounds>
				<font>sheetlabelinline</font>
				<static>STRAIN</static>
			</stringcontrol>

			<numberfield name="attackstrain"><!--{{{-->
				<bounds>175,209,25,25</bounds>
				<tabtarget>
					<prev>rank</prev>
					<next>disciplinename</next>
				</tabtarget>
				<frame>
					<name>modifier</name>
					<offset>3,3,3,3</offset>
				</frame>
				<keyeditframe>
					<name>sheetfocus</name>
					<offset>3,3,3,3</offset>
				</keyeditframe>
				<font>sheetnumber</font>
				<tooltip>attackstrain</tooltip>
				<script>
					function onDoubleClick()
						if User.isHost() then
							userguy = GmIdentityManager.getCurrent();
						else
							userguy = User.getIdentityLabel();
						end
						window.getDatabaseNode().getParent().getParent().getChild("health.damage").setValue(window.getDatabaseNode().getParent().getParent().getChild("health.damage").getValue() + getValue());
						ChatManager.control.deliverMessage({ font = "narratorfont", text = "[" .. userguy .. "]" .. ": Attack roll Strain Damage [" .. window.name.getValue() .. " ( " .. getValue() ..")] --> " .. window.getDatabaseNode().getParent().getParent().getChild("name").getValue(), mode = "emote"});

						if getValue() &gt;= window.getDatabaseNode().getParent().getParent().getChild("health.woundthreshold.total").getValue() then
							window.getDatabaseNode().getParent().getParent().getChild("health.wounds").setValue(window.getDatabaseNode().getParent().getParent().getChild("health.wounds").getValue() + 1);
							ChatManager.control.deliverMessage({ font = "narratorfont", text = "[" .. userguy .. "]" .. ": Attack Roll Strain Wound [" .. window.name.getValue() .. "] --> " .. window.getDatabaseNode().getParent().getParent().getChild("name").getValue(), mode = "emote"});
						end
						if window.getDatabaseNode().getParent().getParent().getChild("totdamage").getValue() &gt;= window.getDatabaseNode().getParent().getParent().getChild("health.death.total").getValue() then
							ChatManager.control.deliverMessage({ font = "narratorfont", text = "[" .. userguy .. "]" .. ": Death [" .. window.name.getValue() .. "] --> " .. window.getDatabaseNode().getParent().getParent().getChild("name").getValue(), mode = "emote"});
						elseif window.getDatabaseNode().getParent().getParent().getChild("totdamage").getValue() &gt;= window.getDatabaseNode().getParent().getParent().getChild("health.unconscious.total").getValue() then
							ChatManager.control.deliverMessage({ font = "narratorfont", text = "[" .. userguy .. "]" .. ": Unconscious [" .. window.name.getValue() .. "] --> " .. window.getDatabaseNode().getParent().getParent().getChild("name").getValue(), mode = "emote"});
						end
							
					end
					function onGainFocus()
						setColor("#FF990099");
						setFrame("sheetfocus", 3, 3, 3, 3);
					end
					
					function onLoseFocus()
						setColor(nil);
						setFrame("modifier", 3, 3, 3, 3);
					end
					function onHover(state)
						if state then
							setColor("#FF882222");
							setFrame("sheetfocus", 3, 3, 3, 3);
						else
							if hasFocus() == false then
								setColor(nil);
								setFrame("modifier", 3, 3, 3, 3);
							end
						end
					end
				</script>
			</numberfield><!--}}}-->

			<numberfield name="damagestrain"><!--{{{-->
				<bounds>203,209,25,25</bounds>
				<tabtarget>
					<prev>rank</prev>
					<next>disciplinename</next>
				</tabtarget>
				<frame>
					<name>modifier</name>
					<offset>3,3,3,3</offset>
				</frame>
				<keyeditframe>
					<name>sheetfocus</name>
					<offset>3,3,3,3</offset>
				</keyeditframe>
				<font>sheetnumber</font>
				<tooltip>damagestrain</tooltip>
				<script>
					function onDoubleClick()
						if User.isHost() then
							userguy = GmIdentityManager.getCurrent();
						else
							userguy = User.getIdentityLabel();
						end
						window.getDatabaseNode().getParent().getParent().getChild("health.damage").setValue(window.getDatabaseNode().getParent().getParent().getChild("health.damage").getValue() + getValue());
						ChatManager.control.deliverMessage({ font = "narratorfont", text = "[" .. userguy .. "]" .. ": Damage roll Strain Damage [" .. window.name.getValue() .. " ( " .. getValue() ..")] --> " .. window.getDatabaseNode().getParent().getParent().getChild("name").getValue(), mode = "emote"});

						if getValue() &gt;= window.getDatabaseNode().getParent().getParent().getChild("health.woundthreshold.total").getValue() then
							window.getDatabaseNode().getParent().getParent().getChild("health.wounds").setValue(window.getDatabaseNode().getParent().getParent().getChild("health.wounds").getValue() + 1);
							ChatManager.control.deliverMessage({ font = "narratorfont", text = "[" .. userguy .. "]" .. ": Damage roll Strain Wound [" .. window.name.getValue() .. "] --> " .. window.getDatabaseNode().getParent().getParent().getChild("name").getValue(), mode = "emote"});
						end
						if window.getDatabaseNode().getParent().getParent().getChild("totdamage").getValue() &gt;= window.getDatabaseNode().getParent().getParent().getChild("health.death.total").getValue() then
							ChatManager.control.deliverMessage({ font = "narratorfont", text = "[" .. userguy .. "]" .. ": Death [" .. window.name.getValue() .. "] --> " .. window.getDatabaseNode().getParent().getParent().getChild("name").getValue(), mode = "emote"});
						elseif window.getDatabaseNode().getParent().getParent().getChild("totdamage").getValue() &gt;= window.getDatabaseNode().getParent().getParent().getChild("health.unconscious.total").getValue() then
							ChatManager.control.deliverMessage({ font = "narratorfont", text = "[" .. userguy .. "]" .. ": Unconscious [" .. window.name.getValue() .. "] --> " .. window.getDatabaseNode().getParent().getParent().getChild("name").getValue(), mode = "emote"});
						end
							
					end
					function onGainFocus()
						setColor("#FF990099");
						setFrame("sheetfocus", 3, 3, 3, 3);
					end
					
					function onLoseFocus()
						setColor(nil);
						setFrame("modifier", 3, 3, 3, 3);
					end
					function onHover(state)
						if state then
							setColor("#FF882222");
							setFrame("sheetfocus", 3, 3, 3, 3);
						else
							if hasFocus() == false then
								setColor(nil);
								setFrame("modifier", 3, 3, 3, 3);
							end
						end
					end
				</script>
			</numberfield><!--}}}-->

			<stringcontrol name="strainonattacklabel"><!--{{{-->
				<bounds>181,237,75,20</bounds>
				<font>sheetlabelsmall</font>
				<static>Attack:</static>
			</stringcontrol>
			<checkbox name="strainonattack">
				<bounds>210,230,25,25</bounds>
				<script>
					function onInit()
						super.onInit();
						if window.strainonattack.getState() == true then
							window.attackstrain.setVisible(true);
						else
							window.attackstrain.setVisible(false);
						end
					end
					function onClickDown(button, x, y)
						setState(not getState());
						if window.strainonattack.getState() == true then
							window.attackstrain.setVisible(true);
						else
							window.attackstrain.setVisible(false);
						end
					end
				</script>
			</checkbox><!--}}}-->
			
			<stringcontrol name="strainondamagelabel"><!--{{{-->
				<bounds>175,252,75,25</bounds>
				<font>sheetlabelsmall</font>
				<static>Damage:</static>
			</stringcontrol>
			<checkbox name="strainondamage">
				<bounds>210,245,25,25</bounds>
				<script>
					function onInit()
						super.onInit();
						if window.strainondamage.getState() == true then
							window.damagestrain.setVisible(true);
						else
							window.damagestrain.setVisible(false);
						end
					end
					function onClickDown(button, x, y)
						setState(not getState());
						if window.strainondamage.getState() == true then
							window.damagestrain.setVisible(true);
						else
							window.damagestrain.setVisible(false);
						end
					end
				</script>
			</checkbox><!--}}}-->
<!--}}}-->

<!-- Range and Ammo --><!--{{{-->
			<genericcontrol name="rangeammoframe">
				<!--<bounds>10,274,226,60</bounds>-->
				<bounds>236,194,226,80</bounds>
				<frame>
					<name>modifier</name>
				</frame>
			</genericcontrol>

<!-- Range --><!--{{{-->
			<stringcontrol name="rangelabel">
				<!--<bounds>15,282,75,20</bounds>-->
				<bounds>241,202,75,20</bounds>
				<font>sheetlabelsmall</font>
				<static>Range:</static>
			</stringcontrol>

			<stringfield name="range">
				<!--<bounds>50,282,177,10</bounds>-->
				<bounds>276,202,177,10</bounds>
				<frame>
					<name>textline</name>
					<offset>1,5,1,1</offset>
				</frame>
				<font>sheetlabelsmall</font>
				<tabtarget>
					<prev>reattune</prev>
					<next>duration</next>
				</tabtarget>
				<script>
					function onGainFocus()
						setColor("#FF990099");
					end
					
					function onLoseFocus()
						setColor(nil);
					end
				</script>
				<empty>melee</empty>
			</stringfield>
<!--}}}-->
<!--AMMO--><!--{{{-->
			<numberfield name="maxammo"><!--{{{-->
				<!--<bounds>60,300,25,20</bounds>-->
				<bounds>286,230,25,20</bounds>
				<frame>
					<name>modifier</name>
					<offset>5,5,5,5</offset>
				</frame>
				<font>sheetnumber</font>
				<keyeditframe>
					<name>sheetfocus</name>
					<offset>5,5,5,5</offset>
				</keyeditframe>
				<stateframe>
					<drophilight>
						<name>sheetfocus</name>
						<offset>5,5,5,5</offset>
					</drophilight>
				</stateframe>
				<droptypes>
					<type>number</type>
				</droptypes>
				<script>
					function onGainFocus()
						setColor("#FF990099");
					end
					
					function onLoseFocus()
						setColor(nil);
					end
					function onHover(state)
						if state then
							setColor("#FF990099");
							setFrame("sheetfocus", 5, 5, 5, 5);
						else
							if hasFocus() == false then
								setColor(nil);
								setFrame("modifier", 5, 5, 5, 5);
							end
						end
					end

					function onValueChanged()
						if getValue() &lt; 0 then
							setValue(0);
						elseif getValue() &gt; 70 then
							setValue(70);
						end
					end
				</script>
				<tabtarget>
					<next>critrange</next>
					<prev>rangeincrement</prev>
				</tabtarget>
			</numberfield><!--}}}-->
			<stringcontrol>
				<anchored>
					<to>maxammo</to>
					<position>lefthigh</position>
					<offset>3,3</offset>
				</anchored>
				<font>sheetlabel</font>
				<static>Ammo</static>
			</stringcontrol>
			
			<genericcontrol name="ammocounter">
				<!--<bounds>98,295,132,33</bounds>-->
				<bounds>314,215,142,53</bounds>
				<stateicons>
					<on>indicator_checkon</on>
					<off>indicator_checkoff</off>
				</stateicons>
				<spacing>
					<horizontal>10</horizontal>
					<vertical>10</vertical>
				</spacing>
				<slotcount>
					<horizontal>14</horizontal>
					<vertical>5</vertical>
				</slotcount>
				<fields>
					<max>maxammo</max>
					<count>ammo</count>
				</fields>
				<script file="scripts/charsheet_ammocounter.lua" />
			</genericcontrol><!--}}}-->
<!--}}}-->

<!-- Description --><!--{{{-->
			<stringcontrol name="descriptionlabel">
				<!--<bounds>15,333,75,20</bounds>-->
				<bounds>15,273,75,20</bounds>
				<font>sheetlabel</font>
				<static>Description:</static>
			</stringcontrol>

			
			<genericcontrol name="frame">
				<!--<bounds>5,327,235,174</bounds>-->
				<bounds>5,267,460,120</bounds>
			</genericcontrol>
			
			<stringfield name="description">
				<tabtarget>
					<prev>circle</prev>
					<next>name</next>
				</tabtarget>
				<anchored>
					<to>frame</to>
					<position>over</position>
					<offset>-14,-19</offset>
				</anchored>
				<multilinespacing>12</multilinespacing>
				<font>chatfont</font>
			</stringfield>
<!--}}}-->

<!--NOTES--><!--{{{-->
			<stringcontrol name="scnoteslabel">
				<!--<bounds>175,335,75,20</bounds>-->
				<bounds>405,273,75,20</bounds>
				<font>sheetlabelsmall</font>
				<static>Notes:</static>
			</stringcontrol>

			<windowreferencefield name="attack_notes_shortcut">
				<!--<bounds>192,333,40,20</bounds>-->
				<bounds>425,271,40,20</bounds>
				<icon>
					<normal>button_openwindow</normal>
					<empty>button_emptytarget</empty>
					<pressed>button_emptytarget</pressed>
				</icon>
				<allowdrop />
			</windowreferencefield>
<!--}}}-->

			<closebutton_charsheet />
			
		</sheetdata>
	</windowclass><!--}}}-->

	<windowclass name="defensefull"><!--{{{-->
		<frame>referencebox</frame>
		<placement>
			<size>
				<height>360</height>
				<width>250</width>
			</size>
		</placement>
		<minimize>minimized_combat</minimize>
		<tooltip>
			<field>name</field>
		</tooltip>
		<sheetdata>
			<stringfield name="name">
				<bounds>20,17,210,25</bounds>
				<font>titlefont</font>
				<tabtarget>
					<prev>description</prev>
					<next>count</next>
				</tabtarget>
				<frame>
					<name>sheetgroup</name>
				<offset>10,7,3,-1</offset>
				</frame>
				<center />
				<script>
					function onGainFocus()
						setColor("#FF990099");
					end
					
					function onLoseFocus()
						setColor(nil);
					end
				</script>
			</stringfield>

			<stringcontrol name="initmodlabel">
				<bounds>16,53,45,20</bounds>
				<font>sheetlabelinline</font>
				<static>Initiative</static>
			</stringcontrol>

			<numberfield name="initmodnum" source="initmodnum.base">
				<bounds>15,36,35,20</bounds>
				<frame>
					<name>textline</name>
					<offset>1,-2,1,1</offset>
				</frame>
				<font>sheettext</font>
				<tabtarget>
					<prev>name</prev>
					<next>valuesp</next>
				</tabtarget>
				<script>
					function onGainFocus()
						setColor("#FF990099");
					end
					
					function onLoseFocus()
						setColor(nil);
					end
				</script>
			</numberfield>

			<stringcontrol name="activelabel">
				<bounds>85,44,75,20</bounds>
				<font>sheetlabelsmall</font>
				<static>Active?:</static>
			</stringcontrol>

			<checkbox name="activebox">
				<bounds>120,38,25,25</bounds>
			</checkbox>

			<stringcontrol name="scnoteslabel">
				<bounds>175,46,75,20</bounds>
				<font>sheetlabelsmall</font>
				<static>Notes:</static>
			</stringcontrol>

			<windowreferencefield name="defense_notes_shortcut">
				<bounds>195,43,40,20</bounds>
				<icon>
					<normal>button_openwindow</normal>
					<empty>button_emptytarget</empty>
					<pressed>button_emptytarget</pressed>
				</icon>
				<allowdrop />
			</windowreferencefield>


<!--VS DEF--><!--{{{-->
			<genericcontrol name="defenseframe">
				<bounds>10,64,160,40</bounds>
				<frame>
					<name>modifier</name>
				</frame>
			</genericcontrol>
			<stringcontrol name="deflabel">
				<anchored>
					<to>defenseframe</to>
					<position>insidetop</position>
					<offset>-45,5</offset>
				</anchored>
				<font>sheetlabelsmallbold</font>
				<static>vs Defense:</static>
			</stringcontrol>


			<stringcontrol name="phydeflabel">
				<bounds>17,82,75,20</bounds>
				<font>sheetlabelsmall</font>
				<static>Physical:</static>
			</stringcontrol>
			<numberfield name="physicaldefensenum" source="physicaldefensenum.base">
				<bounds>55,78,15,20</bounds>
				<frame>
					<name>textline</name>
					<offset>1,1,1,1</offset>
				</frame>
				<font>sheetlabelsmall</font>
				<tabtarget>
					<prev>circle</prev>
					<next>weavethread</next>
				</tabtarget>
				<script>
					function onGainFocus()
						setColor("#FF990099");
					end
					
					function onLoseFocus()
						setColor(nil);
					end
				</script>
			</numberfield>

			
			<stringcontrol name="spelldeflabel">
				<bounds>75,82,25,25</bounds>
				<font>sheetlabelsmall</font>
				<static>Spell:</static>
			</stringcontrol>
			<numberfield name="spelldefensenum" source="spelldefensenum.base">
				<bounds>101,78,15,20</bounds>
				<frame>
					<name>textline</name>
					<offset>1,1,1,1</offset>
				</frame>
				<font>sheetlabelsmall</font>
				<tabtarget>
					<prev>circle</prev>
					<next>weavethread</next>
				</tabtarget>
				<script>
					function onGainFocus()
						setColor("#FF990099");
					end
					
					function onLoseFocus()
						setColor(nil);
					end
				</script>
			</numberfield>
			
			<stringcontrol name="socialdeflabel">
				<bounds>120,82,25,25</bounds>
				<font>sheetlabelsmall</font>
				<static>Social:</static>
			</stringcontrol>
			<numberfield name="socialdefensenum" source="socialdefensenum.base">
				<bounds>148,78,15,20</bounds>
				<frame>
					<name>textline</name>
					<offset>1,1,1,1</offset>
				</frame>
				<font>sheetlabelsmall</font>
				<tabtarget>
					<prev>circle</prev>
					<next>weavethread</next>
				</tabtarget>
				<script>
					function onGainFocus()
						setColor("#FF990099");
					end
					
					function onLoseFocus()
						setColor(nil);
					end
				</script>
			</numberfield>
<!--}}}-->

<!--VS ARMOR--><!--{{{-->
			<genericcontrol name="armorframe">
				<bounds>10,104,160,40</bounds>
				<frame>
					<name>modifier</name>
				</frame>
			</genericcontrol>
			<stringcontrol name="armorlabel">
				<anchored>
					<to>armorframe</to>
					<position>insidetop</position>
					<offset>-45,5</offset>
				</anchored>
				<font>sheetlabelsmallbold</font>
				<static>vs Armor:</static>
			</stringcontrol>


			<stringcontrol name="phyarmorlabel">
				<bounds>17,122,75,20</bounds>
				<font>sheetlabelsmall</font>
				<static>Physical:</static>
			</stringcontrol>
			<numberfield name="physicalarmornum" source="physicalarmornum.base">
				<bounds>55,118,15,20</bounds>
				<frame>
					<name>textline</name>
					<offset>1,1,1,1</offset>
				</frame>
				<font>sheetlabelsmall</font>
				<tabtarget>
					<prev>circle</prev>
					<next>weavethread</next>
				</tabtarget>
				<script>
					function onGainFocus()
						setColor("#FF990099");
					end
					
					function onLoseFocus()
						setColor(nil);
					end
				</script>
			</numberfield>
			
			<stringcontrol name="mysticarmorlabel">
				<bounds>75,122,30,25</bounds>
				<font>sheetlabelsmall</font>
				<static>Mystic:</static>
			</stringcontrol>
			<numberfield name="mysticarmornum" source="mysticarmornum.base">
				<bounds>108,118,15,20</bounds>
				<frame>
					<name>textline</name>
					<offset>1,1,1,1</offset>
				</frame>
				<font>sheetlabelsmall</font>
				<tabtarget>
					<prev>circle</prev>
					<next>weavethread</next>
				</tabtarget>
				<script>
					function onGainFocus()
						setColor("#FF990099");
					end
					
					function onLoseFocus()
						setColor(nil);
					end
				</script>
			</numberfield>
			
<!--}}}-->

<!-- Strain --> <!--{{{-->
			<genericcontrol name="defenseframe">
				<bounds>167,64,69,80</bounds>
				<frame>
					<name>modifier</name>
				</frame>
			</genericcontrol>
			<stringcontrol name="strainlabel">
				<bounds>184,69,40,20</bounds>
				<font>sheetlabelinline</font>
				<static>STRAIN</static>
			</stringcontrol>

			<numberfield name="attackstrain"><!--{{{-->
				<bounds>175,79,25,25</bounds>
				<tabtarget>
					<prev>rank</prev>
					<next>disciplinename</next>
				</tabtarget>
				<frame>
					<name>modifier</name>
					<offset>3,3,3,3</offset>
				</frame>
				<keyeditframe>
					<name>sheetfocus</name>
					<offset>3,3,3,3</offset>
				</keyeditframe>
				<font>sheetnumber</font>
				<tooltip>attackstrain</tooltip>
				<script>
					function onDoubleClick()
						if User.isHost() then
							userguy = GmIdentityManager.getCurrent();
						else
							userguy = User.getIdentityLabel();
						end
						window.getDatabaseNode().getParent().getParent().getChild("health.damage").setValue(window.getDatabaseNode().getParent().getParent().getChild("health.damage").getValue() + getValue());
						ChatManager.control.deliverMessage({ font = "narratorfont", text = "[" .. userguy .. "]" .. ": Strain Damage [" .. window.name.getValue() .. " ( " .. getValue() ..")] --> " .. window.getDatabaseNode().getParent().getParent().getChild("name").getValue(), mode = "emote"});

						if getValue() &gt;= window.getDatabaseNode().getParent().getParent().getChild("health.woundthreshold.total").getValue() then
							window.getDatabaseNode().getParent().getParent().getChild("health.wounds").setValue(window.getDatabaseNode().getParent().getParent().getChild("health.wounds").getValue() + 1);
							ChatManager.control.deliverMessage({ font = "narratorfont", text = "[" .. userguy .. "]" .. ": Strain Wound [" .. window.name.getValue() .. "] --> " .. window.getDatabaseNode().getParent().getParent().getChild("name").getValue(), mode = "emote"});
						end
						if window.getDatabaseNode().getParent().getParent().getChild("totdamage").getValue() &gt;= window.getDatabaseNode().getParent().getParent().getChild("health.death.total").getValue() then
							ChatManager.control.deliverMessage({ font = "narratorfont", text = "[" .. userguy .. "]" .. ": Death [" .. window.name.getValue() .. "] --> " .. window.getDatabaseNode().getParent().getParent().getChild("name").getValue(), mode = "emote"});
						elseif window.getDatabaseNode().getParent().getParent().getChild("totdamage").getValue() &gt;= window.getDatabaseNode().getParent().getParent().getChild("health.unconscious.total").getValue() then
							ChatManager.control.deliverMessage({ font = "narratorfont", text = "[" .. userguy .. "]" .. ": Unconscious [" .. window.name.getValue() .. "] --> " .. window.getDatabaseNode().getParent().getParent().getChild("name").getValue(), mode = "emote"});
						end
							
					end
					function onGainFocus()
						setColor("#FF990099");
						setFrame("sheetfocus", 3, 3, 3, 3);
					end
					
					function onLoseFocus()
						setColor(nil);
						setFrame("modifier", 3, 3, 3, 3);
					end
					function onHover(state)
						if state then
							setColor("#FF882222");
							setFrame("sheetfocus", 3, 3, 3, 3);
						else
							if hasFocus() == false then
								setColor(nil);
								setFrame("modifier", 3, 3, 3, 3);
							end
						end
					end
				</script>
			</numberfield><!--}}}-->

			<numberfield name="damagestrain"><!--{{{-->
				<bounds>203,79,25,25</bounds>
				<tabtarget>
					<prev>rank</prev>
					<next>disciplinename</next>
				</tabtarget>
				<frame>
					<name>modifier</name>
					<offset>3,3,3,3</offset>
				</frame>
				<keyeditframe>
					<name>sheetfocus</name>
					<offset>3,3,3,3</offset>
				</keyeditframe>
				<font>sheetnumber</font>
				<tooltip>damagestrain</tooltip>
				<script>
					function onDoubleClick()
						if User.isHost() then
							userguy = GmIdentityManager.getCurrent();
						else
							userguy = User.getIdentityLabel();
						end
						window.getDatabaseNode().getParent().getParent().getChild("health.damage").setValue(window.getDatabaseNode().getParent().getParent().getChild("health.damage").getValue() + getValue());
						ChatManager.control.deliverMessage({ font = "narratorfont", text = "[" .. userguy .. "]" .. ": Strain Damage [" .. window.name.getValue() .. " ( " .. getValue() ..")] --> " .. window.getDatabaseNode().getParent().getParent().getChild("name").getValue(), mode = "emote"});

						if getValue() &gt;= window.getDatabaseNode().getParent().getParent().getChild("health.woundthreshold.total").getValue() then
							window.getDatabaseNode().getParent().getParent().getChild("health.wounds").setValue(window.getDatabaseNode().getParent().getParent().getChild("health.wounds").getValue() + 1);
							ChatManager.control.deliverMessage({ font = "narratorfont", text = "[" .. userguy .. "]" .. ": Strain Wound [" .. window.name.getValue() .. "] --> " .. window.getDatabaseNode().getParent().getParent().getChild("name").getValue(), mode = "emote"});
						end
						if window.getDatabaseNode().getParent().getParent().getChild("totdamage").getValue() &gt;= window.getDatabaseNode().getParent().getParent().getChild("health.death.total").getValue() then
							ChatManager.control.deliverMessage({ font = "narratorfont", text = "[" .. userguy .. "]" .. ": Death [" .. window.name.getValue() .. "] --> " .. window.getDatabaseNode().getParent().getParent().getChild("name").getValue(), mode = "emote"});
						elseif window.getDatabaseNode().getParent().getParent().getChild("totdamage").getValue() &gt;= window.getDatabaseNode().getParent().getParent().getChild("health.unconscious.total").getValue() then
							ChatManager.control.deliverMessage({ font = "narratorfont", text = "[" .. userguy .. "]" .. ": Unconscious [" .. window.name.getValue() .. "] --> " .. window.getDatabaseNode().getParent().getParent().getChild("name").getValue(), mode = "emote"});
						end
							
					end
					function onGainFocus()
						setColor("#FF990099");
						setFrame("sheetfocus", 3, 3, 3, 3);
					end
					
					function onLoseFocus()
						setColor(nil);
						setFrame("modifier", 3, 3, 3, 3);
					end
					function onHover(state)
						if state then
							setColor("#FF882222");
							setFrame("sheetfocus", 3, 3, 3, 3);
						else
							if hasFocus() == false then
								setColor(nil);
								setFrame("modifier", 3, 3, 3, 3);
							end
						end
					end
				</script>
			</numberfield><!--}}}-->

			<stringcontrol name="strainonattacklabel">
				<bounds>181,107,75,20</bounds>
				<font>sheetlabelsmall</font>
				<static>Attack:</static>
			</stringcontrol>
			<checkbox name="strainonattack">
				<bounds>210,100,25,25</bounds>
				<script>
					function onInit()
						super.onInit();
						if window.strainonattack.getState() == true then
							window.attackstrain.setVisible(true);
						else
							window.attackstrain.setVisible(false);
						end
					end
					function onClickDown(button, x, y)
						setState(not getState());
						if window.strainonattack.getState() == true then
							window.attackstrain.setVisible(true);
						else
							window.attackstrain.setVisible(false);
						end
					end
				</script>
			</checkbox>
			
			<stringcontrol name="strainondamagelabel">
				<bounds>175,122,75,25</bounds>
				<font>sheetlabelsmall</font>
				<static>Damage:</static>
			</stringcontrol>
			<checkbox name="strainondamage">
				<bounds>210,115,25,25</bounds>
				<script>
					function onInit()
						super.onInit();
						if window.strainondamage.getState() == true then
							window.damagestrain.setVisible(true);
						else
							window.damagestrain.setVisible(false);
						end
					end
					function onClickDown(button, x, y)
						setState(not getState());
						if window.strainondamage.getState() == true then
							window.damagestrain.setVisible(true);
						else
							window.damagestrain.setVisible(false);
						end
					end
				</script>
			</checkbox>
<!--}}}-->

<!--VS HEALTH--><!--{{{-->
			<genericcontrol name="healthframe">
				<bounds>10,145,-14,40</bounds>
				<frame>
					<name>modifier</name>
				</frame>
			</genericcontrol>
			<stringcontrol name="healthlabel">
				<anchored>
					<to>healthframe</to>
					<position>insidetop</position>
					<offset>-85,5</offset>
				</anchored>
				<font>sheetlabelsmallbold</font>
				<static>vs Health:</static>
			</stringcontrol>


			<stringcontrol name="wndthreshlabel">
				<bounds>17,163,75,20</bounds>
				<font>sheetlabelsmall</font>
				<static>Wnd Thr:</static>
			</stringcontrol>
			<numberfield name="wndthreshnum" source="wndthreshnum.base">
				<bounds>63,159,15,20</bounds>
				<frame>
					<name>textline</name>
					<offset>1,1,1,1</offset>
				</frame>
				<font>sheetlabelsmall</font>
				<script>
					function onGainFocus()
						setColor("#FF990099");
					end
					
					function onLoseFocus()
						setColor(nil);
					end
				</script>
			</numberfield>

			
			<stringcontrol name="unconlabel">
				<bounds>85,163,75,25</bounds>
				<font>sheetlabelsmall</font>
				<static>Unconscious:</static>
			</stringcontrol>
			<numberfield name="unconnum" source="unconnum.base">
				<bounds>145,159,15,20</bounds>
				<frame>
					<name>textline</name>
					<offset>1,1,1,1</offset>
				</frame>
				<font>sheetlabelsmall</font>
				<script>
					function onGainFocus()
						setColor("#FF990099");
					end
					
					function onLoseFocus()
						setColor(nil);
					end
				</script>
			</numberfield>
			
			<stringcontrol name="deathlabel">
				<bounds>170,163,35,25</bounds>
				<font>sheetlabelsmall</font>
				<static>Death:</static>
			</stringcontrol>
			<numberfield name="deathnum" source="deathnum.base">
				<bounds>203,159,15,20</bounds>
				<frame>
					<name>textline</name>
					<offset>1,1,1,1</offset>
				</frame>
				<font>sheetlabelsmall</font>
				<tabtarget>
					<prev>circle</prev>
					<next>weavethread</next>
				</tabtarget>
				<script>
					function onGainFocus()
						setColor("#FF990099");
					end
					
					function onLoseFocus()
						setColor(nil);
					end
				</script>
			</numberfield>
<!--}}}-->



			<stringcontrol name="descriptionlabel">
				<bounds>15,185,75,20</bounds>
				<font>sheetlabel</font>
				<static>Description:</static>
			</stringcontrol>

			<genericcontrol name="frame">
				<bounds>5,180,235,180</bounds>
			</genericcontrol>
			
			<stringfield name="description">
				<anchored>
					<to>frame</to>
					<position>over</position>
					<offset>-14,-19</offset>
				</anchored>
				<multilinespacing>12</multilinespacing>
				<font>chatfont</font>
				<tabtarget>
					<prev>totalweight</prev>
					<next>name</next>
				</tabtarget>
			</stringfield>
			<closebutton_charsheet />
			
		</sheetdata>
	</windowclass><!--}}}-->

	<windowclass name="threadfull"><!--{{{-->
		<frame>referencebox</frame>
		<placement>
			<size>
				<height>285</height>
				<width>250</width>
			</size>
		</placement>
		<sheetdata>
			<stringfield name="tiedto">
				<bounds>20,17,210,25</bounds>
				<font>titlefont</font>
				<tabtarget>
					<prev>description</prev>
					<next>disciplinename</next>
				</tabtarget>
				<frame>
					<name>sheetgroup</name>
				<offset>10,7,3,-1</offset>
				</frame>
				<center />
				<script>
					function onGainFocus()
						setColor("#FF990099");
					end
					
					function onLoseFocus()
						setColor(nil);
					end
				</script>
			</stringfield>

			<labelednumber name="thrnum">
				<bounds>15,36,25,20</bounds>
				<label>Thr #</label>
				<center />
				<tabtarget>
					<prev>disciplinename</prev>
					<next>numthreads</next>
				</tabtarget>
			</labelednumber>

			<stringcontrol name="scnoteslabel">
				<bounds>85,44,75,20</bounds>
				<font>sheetlabelsmall</font>
				<static>Notes:</static>
			</stringcontrol>

			<windowreferencefield name="thread_notes_shortcut">
				<bounds>105,41,40,20</bounds>
				<icon>
					<normal>button_openwindow</normal>
					<empty>button_emptytarget</empty>
					<pressed>button_emptytarget</pressed>
				</icon>
				<allowdrop />
			</windowreferencefield>

			<labelednumber name="rank">
				<bounds>207,36,25,20</bounds>
				<label>rank</label>
				<center />
				<tabtarget>
					<prev>disciplinename</prev>
					<next>numthreads</next>
				</tabtarget>
			</labelednumber>


			<stringcontrol name="descriptionlabel">
				<bounds>15,65,75,20</bounds>
				<font>sheetlabel</font>
				<static>Description:</static>
			</stringcontrol>
			<genericcontrol name="frame">
				<bounds>5,60,235,230</bounds>
			</genericcontrol>
			<stringfield name="effect">
				<anchored>
					<to>frame</to>
					<position>over</position>
					<offset>-14,-19</offset>
				</anchored>
				<multilinespacing>20</multilinespacing>
				<font>sheettext</font>
				<frame>
					<name>textline</name>
					<offset>2,0,2,0</offset>
				</frame>
				<tabtarget>
					<prev>effecttext</prev>
					<next>name</next>
				</tabtarget>
			</stringfield>
			<closebutton_charsheet />
			
		</sheetdata>
	</windowclass><!--}}}-->

	<windowclass name="bloodmagicfull"><!--{{{-->
		<frame>referencebox</frame>
		<placement>
			<size>
				<height>285</height>
				<width>250</width>
			</size>
		</placement>
		<sheetdata>
			<stringfield name="name">
				<bounds>20,17,210,25</bounds>
				<font>titlefont</font>
				<tabtarget>
					<prev>description</prev>
					<next>disciplinename</next>
				</tabtarget>
				<frame>
					<name>sheetgroup</name>
				<offset>10,7,3,-1</offset>
				</frame>
				<center />
				<script>
					function onGainFocus()
						setColor("#FF990099");
					end
					
					function onLoseFocus()
						setColor(nil);
					end
				</script>
			</stringfield>

			<labelednumber name="bloodmagicdam">
				<bounds>15,36,35,20</bounds>
				<label>Damage</label>
				<center />
				<tabtarget>
					<prev>disciplinename</prev>
					<next>numthreads</next>
				</tabtarget>
			</labelednumber>

			<stringcontrol name="scnoteslabel">
				<bounds>85,42,75,20</bounds>
				<font>sheetlabelsmall</font>
				<static>Notes:</static>
			</stringcontrol>

			<windowreferencefield name="bloodmagic_notes_shortcut">
				<bounds>105,41,40,20</bounds>
				<icon>
					<normal>button_openwindow</normal>
					<empty>button_emptytarget</empty>
					<pressed>button_emptytarget</pressed>
				</icon>
				<allowdrop />
			</windowreferencefield>



			<stringcontrol name="strainlabel">
				<bounds>197,61,75,20</bounds>
				<font>sheetlabelinline</font>
				<static>STRAIN</static>
			</stringcontrol>
			<numberfield name="strain">
				<bounds>203,38,25,25</bounds>
				<tabtarget>
					<prev>rank</prev>
					<next>disciplinename</next>
				</tabtarget>
				<frame>
					<name>modifier</name>
					<offset>3,3,3,3</offset>
				</frame>
				<keyeditframe>
					<name>sheetfocus</name>
					<offset>3,3,3,3</offset>
				</keyeditframe>
				<font>sheetnumber</font>
				<script>
					function onDoubleClick()
						if User.isHost() then
							userguy = GmIdentityManager.getCurrent();
						else
							userguy = User.getIdentityLabel();
						end
						window.getDatabaseNode().getParent().getParent().getChild("health.damage").setValue(window.getDatabaseNode().getParent().getParent().getChild("health.damage").getValue() + getValue());
						ChatManager.control.deliverMessage({ font = "narratorfont", text = "[" .. userguy .. "]" .. ": Strain Damage [" .. window.name.getValue() .. " ( " .. getValue() ..")] --> " .. window.getDatabaseNode().getParent().getParent().getChild("name").getValue(), mode = "emote"});

						if getValue() &gt;= window.getDatabaseNode().getParent().getParent().getChild("health.woundthreshold.total").getValue() then
							window.getDatabaseNode().getParent().getParent().getChild("health.wounds").setValue(window.getDatabaseNode().getParent().getParent().getChild("health.wounds").getValue() + 1);
							ChatManager.control.deliverMessage({ font = "narratorfont", text = "[" .. userguy .. "]" .. ": Strain Wound [" .. window.name.getValue() .. "] --> " .. window.getDatabaseNode().getParent().getParent().getChild("name").getValue(), mode = "emote"});
						end
						if window.getDatabaseNode().getParent().getParent().getChild("totdamage").getValue() &gt;= window.getDatabaseNode().getParent().getParent().getChild("health.death.total").getValue() then
							ChatManager.control.deliverMessage({ font = "narratorfont", text = "[" .. userguy .. "]" .. ": Death [" .. window.name.getValue() .. "] --> " .. window.getDatabaseNode().getParent().getParent().getChild("name").getValue(), mode = "emote"});
						elseif window.getDatabaseNode().getParent().getParent().getChild("totdamage").getValue() &gt;= window.getDatabaseNode().getParent().getParent().getChild("health.unconscious.total").getValue() then
							ChatManager.control.deliverMessage({ font = "narratorfont", text = "[" .. userguy .. "]" .. ": Unconscious [" .. window.name.getValue() .. "] --> " .. window.getDatabaseNode().getParent().getParent().getChild("name").getValue(), mode = "emote"});
						end
							
					end
					function onGainFocus()
						setColor("#FF990099");
						setFrame("sheetfocus", 3, 3, 3, 3);
					end
					
					function onLoseFocus()
						setColor(nil);
						setFrame("modifier", 3, 3, 3, 3);
					end
					function onHover(state)
						if state then
							setColor("#FF882222");
							setFrame("sheetfocus", 3, 3, 3, 3);
						else
							if hasFocus() == false then
								setColor(nil);
								setFrame("modifier", 3, 3, 3, 3);
							end
						end
					end
				</script>
			</numberfield>



			
			<stringcontrol name="descriptionlabel">
				<bounds>15,65,75,20</bounds>
				<font>sheetlabel</font>
				<static>Description:</static>
			</stringcontrol>
			<genericcontrol name="frame">
				<bounds>5,60,235,220</bounds>
			</genericcontrol>
			<stringfield name="bmeffect">
				<anchored>
					<to>frame</to>
					<position>over</position>
					<offset>-14,-19</offset>
				</anchored>
				<multilinespacing>20</multilinespacing>
				<font>sheettext</font>
				<frame>
					<name>textline</name>
					<offset>2,0,2,0</offset>
				</frame>
				<tabtarget>
					<prev>effecttext</prev>
					<next>name</next>
				</tabtarget>
			</stringfield>
			<closebutton_charsheet />
			
		</sheetdata>
	</windowclass>

	<windowclass name="rk_modifiers"> <!--{{{--> 
		<frame>sheetgroup</frame>
		<placement>
			<size>
				<height>400</height>
				<width>400</width>
			</size>
		</placement>
		<sizelimits>
			<dynamic />
		</sizelimits>
		<sheetdata>
			<stringcontrol name="label">
				<bounds>25,15,155,25</bounds>
				<font>sheetlabel</font>
			</stringcontrol>
			
			<genericcontrol name="frame">
				<bounds>5,15,300,120</bounds>
				<!-- <frame>
					<name>modifier</name>
				</frame> -->
			</genericcontrol>
			
			<stringfield name="notes">
				<anchored>
					<to>frame</to>
					<position>over</position>
					<offset>-14,-19</offset>
				</anchored>
				<multilinespacing>20</multilinespacing>
				<font>sheettext</font>
				<frame>
					<name>textline</name>
					<offset>2,0,2,0</offset>
				</frame>
			</stringfield>
			<numberfield name="maxammo">
				<bounds>60,150,25,20</bounds>
				<frame>
					<name>modifier</name>
					<offset>5,5,5,5</offset>
				</frame>
				<font>sheetnumber</font>
				<keyeditframe>
					<name>sheetfocus</name>
					<offset>5,5,5,5</offset>
				</keyeditframe>
				<stateframe>
					<drophilight>
						<name>sheetfocus</name>
						<offset>5,5,5,5</offset>
					</drophilight>
				</stateframe>
				<droptypes>
					<type>number</type>
				</droptypes>
				<script>
					function onValueChanged()
						if getValue() &lt; 0 then
							setValue(0);
						elseif getValue() &gt; 40 then
							setValue(40);
						end
					end
				</script>
				<tabtarget>
					<next>critrange</next>
					<prev>rangeincrement</prev>
				</tabtarget>
			</numberfield>
			<stringcontrol>
				<anchored>
					<to>maxammo</to>
					<position>lefthigh</position>
					<offset>3,5</offset>
				</anchored>
				<font>sheetlabel</font>
				<static>Ammo</static>
			</stringcontrol>
			
			<genericcontrol name="ammocounter">
				<bounds>98,150,102,22</bounds>
				<stateicons>
					<on>indicator_checkon</on>
					<off>indicator_checkoff</off>
				</stateicons>
				<spacing>
					<horizontal>10</horizontal>
					<vertical>10</vertical>
				</spacing>
				<slotcount>
					<horizontal>10</horizontal>
					<vertical>2</vertical>
				</slotcount>
				<fields>
					<max>maxammo</max>
					<count>ammo</count>
				</fields>
				<script file="scripts/charsheet_ammocounter.lua" />
			</genericcontrol>
			<closebutton_charsheet />
		</sheetdata>
	</windowclass><!--}}}-->


    

</root>
