<?xml version="1.0" encoding="iso-8859-1"?>
<root version="2.0">
	<windowclass name="attack_listitem">
		<sizelimits>
			<minimum>
				<height>20</height>
			</minimum>
		</sizelimits>
		<sheetdata>
			
			<textlistitemvalue name="name">
				<anchored>
					<left>
						<anchor>left</anchor>
						<offset>0</offset>
					</left>
					<top>
						<anchor>top</anchor>
						<offset>0</offset>
					</top>
					<size>
						<width>135</width>
					</size>
				</anchored>
				<tabtarget>
					<next>disciplinename</next>
					<prev>circle</prev>
				</tabtarget>
				<font>sheettextsmall</font>
				<script>
					function onLoseFocus()
						super.onLoseFocus();
						window.windowlist.applySort();
					end
					function onDoubleClick()
						win = Interface.openWindow("attackfull",window.getDatabaseNode());
					end
				</script>
			</textlistitemvalue>
			<stringcontrol name="karmaonattacklabel">
				<bounds>0,0,0,0</bounds>
				<font>sheetlabelsmall</font>
				<static>Karma:</static>
				<invisible />
			</stringcontrol>
			<checkbox name="karmaonattack">
				<invisible />
				<bounds>0,0,0,0</bounds>
			</checkbox>
			<checkbox name="karmaonattackvis">
				<invisible />
				<bounds>0,0,0,0</bounds>
			</checkbox>
			<stringfield name="attackkarmaclass" source="attackkarmaclass">
				<invisible />
				<bounds>0,0,0,0</bounds>
			</stringfield>
			<modifiernumber name="attackstep" source="attackstep.total">
				<anchored>
					<left>
						<anchor>left</anchor>
						<offset>143</offset>
					</left>
					<top>
						<anchor>top</anchor>
						<offset>-1</offset>
					</top>
					<size>
						<width>20</width>
					</size>
				</anchored>
				<frame>
					<name>modifier</name>
					<offset>3,3,3,3</offset>
				</frame>
				<font>sheetnumber</font>
				<readonly />
				<source>
					<name>attackbonusonestep</name>
					<op>+</op>
				</source>
				<source>
					<name>attackbonustwostep</name>
					<op>+</op>
				</source>
				<source>
					<name>attackbonusthreestep</name>
					<op>+</op>
				</source>
				<source>
					<name>attackbonusfourstep</name>
					<op>+</op>
				</source>
				<source>
					<name>attackbonusfivestep</name>
					<op>+</op>
				</source>
				<source>
					<name>attackbonussixstep</name>
					<op>+</op>
				</source>
				<source>
					<name>attackbonussevenstep</name>
					<op>+</op>
				</source>
				<modifierfield>attackstep.total.temp</modifierfield>
				<modifierloc>right</modifierloc>
				<script>
					function onDrag(button,x,y,dragdata)
						dragdata.setType("dice");
						dragdata.setSlot(1);
						dice = {};
						mod = 0;
						dice, mod = Step.getStepDice(getValue());
						dragdata.setDieList(dice);
						
						dragdata.setDescription(window.name.getValue() .. " (Attack Step " .. getValue() .. ")" );
						dragdata.setNumberData(mod);
						
						return true;
					end	

					function onDoubleClick()
						dice = {};
						mod = 0;
						dice, mod = Step.getStepDice(getValue());

						attackkarmastep = 0;
						karmaaddedtext = "";

						if window.karmaonattackvis.getState() and window.karmaonattack.getState() then
							local node = window.getDatabaseNode().getParent().getParent();
							local source = node.getChild("discipline");
							local templist = source.getChildren();
							found = 0;
							attackkarmastep = 0;
							for i in pairs(templist) do
								if templist[i].getChild("name") then
									local discname = templist[i].getChild("name").getValue();
									if discname == window.attackkarmaclass.getValue() and found == 0 and templist[i].getChild("curr").getValue() &gt;= 1 then
										found = 1;
										attackkarmastep = templist[i].getChild("kstep").getValue();
										templist[i].getChild("curr").setValue(templist[i].getChild("curr").getValue() - 1);
										karmaaddedtext = " + Step " .. attackkarmastep .. " " .. window.attackkarmaclass.getValue() .. " Karma";
										
									end
								end
							end
							if attackkarmastep &gt;= 1 then
								dicea = {};
								dicea, mod = Step.getStepDice(attackkarmastep);
								for k,v in pairs(dicea) do 
									table.insert(dice, v) 
								end
							end
						end
						if window.strainonattack.getState() == true then
							window.attackstrain.onDoubleClick();
						end
						ChatManager.control.throwDice("dice",dice, mod, window.name.getValue() .. " (Attack Step " .. getValue() .. karmaaddedtext .. ")");
					end

					function onHover(state)
						if state then
							setColor("#FF228822");
							setFrame("sheetfocus", 3, 3, 3, 3);
							window.setFrame("rowshade");
						else
							if hasFocus() == false then
								setColor(nil);
								setFrame("modifier", 3, 3, 3, 3);
								window.setFrame(nil);
							end
						end
					end
				</script>
			</modifiernumber>
			<stringcontrol name="karmaondamagelabel">
				<bounds>0,0,0,0</bounds>
				<font>sheetlabelsmall</font>
				<static>Karma:</static>
				<invisible />
			</stringcontrol>
			<checkbox name="karmaondamage">
				<invisible />
				<bounds>0,0,0,0</bounds>
			</checkbox>
			<checkbox name="karmaondamagevis">
				<invisible />
				<bounds>0,0,0,0</bounds>
			</checkbox>
			<stringfield name="damagekarmaclass" source="damagekarmaclass">
				<invisible />
				<bounds>0,0,0,0</bounds>
			</stringfield>
			
			<modifiernumber name="damagestep" source="damagestep.total">
				<anchored>
					<left>
						<anchor>left</anchor>
						<offset>182</offset>
					</left>
					<top>
						<anchor>top</anchor>
						<offset>-1</offset>
					</top>
					<size>
						<width>20</width>
					</size>
				</anchored>
				<frame>
					<name>modifier</name>
					<offset>3,3,3,3</offset>
				</frame>
				<font>sheetnumber</font>
				<readonly />
				<source>
					<name>damagebonusonestep</name>
					<op>+</op>
				</source>
				<source>
					<name>damagebonustwostep</name>
					<op>+</op>
				</source>
				<source>
					<name>damagebonusthreestep</name>
					<op>+</op>
				</source>
				<source>
					<name>damagebonusfourstep</name>
					<op>+</op>
				</source>
				<source>
					<name>damagebonusfivestep</name>
					<op>+</op>
				</source>
				<source>
					<name>damagebonussixstep</name>
					<op>+</op>
				</source>
				<source>
					<name>damagebonussevenstep</name>
					<op>+</op>
				</source>
				<modifierfield>damagestep.total.temp</modifierfield>
				<modifierloc>right</modifierloc>
				<script>
					function onDrag(button,x,y,dragdata)
						dragdata.setType("dice");
						dragdata.setSlot(1);
						dice = {};
						mod = 0;
						dice, mod = Step.getStepDice(getValue());
						dragdata.setDieList(dice);
						
						dragdata.setDescription(window.name.getValue() .. " (Damage Step " .. getValue() .. ")" );
						dragdata.setNumberData(mod);
						
						return true;
					end	
					function onDoubleClick()
						dice = {};
						mod = 0;
						dice, mod = Step.getStepDice(getValue());

						damagekarmastep = 0;
						karmaaddedtext = "";

						if window.karmaondamagevis.getState() and window.karmaondamage.getState() then
							local node = window.getDatabaseNode().getParent().getParent();
							local source = node.getChild("discipline");
							local templist = source.getChildren();
							found = 0;
							damagekarmastep = 0;
							for i in pairs(templist) do
								if templist[i].getChild("name") then
									local discname = templist[i].getChild("name").getValue();
									if discname == window.damagekarmaclass.getValue() and found == 0 and templist[i].getChild("curr").getValue() &gt;= 1 then
										found = 1;
										damagekarmastep = templist[i].getChild("kstep").getValue();
										templist[i].getChild("curr").setValue(templist[i].getChild("curr").getValue() - 1);
										karmaaddedtext = " + Step " .. damagekarmastep .. " " .. window.damagekarmaclass.getValue() .. " Karma";
										
									end
								end
							end
							if damagekarmastep &gt;= 1 then
								dicea = {};
								dicea, mod = Step.getStepDice(damagekarmastep);
								for k,v in pairs(dicea) do 
									table.insert(dice, v) 
								end
							end
						end
						if window.strainondamage.getState() == true then
							window.damagestrain.onDoubleClick();
						end
						ChatManager.control.throwDice("dice",dice, mod, window.name.getValue() .. " (Damage Step " .. getValue() .. karmaaddedtext .. ")");
					end


					function onHover(state)
						if state then
							setColor("#FF228822");
							setFrame("sheetfocus", 3, 3, 3, 3);
							window.setFrame("rowshade");
						else
							if hasFocus() == false then
								setColor(nil);
								setFrame("modifier", 3, 3, 3, 3);
								window.setFrame(nil);
							end
						end
					end
				</script>
			</modifiernumber>

			<checkbox name="physicaldefense">
				<anchored>
					<left>
						<anchor>left</anchor>
						<offset>219</offset>
					</left>
					<top>
						<anchor>top</anchor>
						<offset>3</offset>
					</top>
					<size>
						<width>15</width>
						<height>15</height>
					</size>
				</anchored>
				<script>
					function onClickDown()
						return false;
					end
				</script>
				<tooltip>
					<text>vs Physical Defense</text>
				</tooltip>
			</checkbox>
			
			<checkbox name="spelldefense">
				<anchored>
					<left>
						<anchor>left</anchor>
						<offset>235</offset>
					</left>
					<top>
						<anchor>top</anchor>
						<offset>3</offset>
					</top>
					<size>
						<width>15</width>
						<height>15</height>
					</size>
				</anchored>
				<script>
					function onClickDown()
						return false;
					end
				</script>
				<tooltip>
					<text>vs Spell Defense</text>
				</tooltip>
			</checkbox>
			
			<checkbox name="socialdefense">
				<anchored>
					<left>
						<anchor>left</anchor>
						<offset>251</offset>
					</left>
					<top>
						<anchor>top</anchor>
						<offset>3</offset>
					</top>
					<size>
						<width>15</width>
						<height>15</height>
					</size>
				</anchored>
				<script>
					function onClickDown()
						return false;
					end
				</script>
				<tooltip>
					<text>vs Social Defense</text>
				</tooltip>
			</checkbox>

			<checkbox name="physicalarmor">
				<anchored>
					<left>
						<anchor>left</anchor>
						<offset>272</offset>
					</left>
					<top>
						<anchor>top</anchor>
						<offset>3</offset>
					</top>
					<size>
						<width>15</width>
						<height>15</height>
					</size>
				</anchored>
				<script>
					function onClickDown()
						return false;
					end
				</script>
				<tooltip>
					<text>vs Physical Armor</text>
				</tooltip>
			</checkbox>
			
			<checkbox name="mysticarmor">
				<anchored>
					<left>
						<anchor>left</anchor>
						<offset>290</offset>
					</left>
					<top>
						<anchor>top</anchor>
						<offset>3</offset>
					</top>
					<size>
						<width>15</width>
						<height>15</height>
					</size>
				</anchored>
				<script>
					function onClickDown()
						return false;
					end
				</script>
				<tooltip>
					<text>vs Mystic Armor</text>
				</tooltip>
			</checkbox>
			
			
			<textlistitemvalue name="range">
				<anchored>
					<left>
						<anchor>left</anchor>
						<offset>313</offset>
					</left>
					<top>
						<anchor>top</anchor>
						<offset>0</offset>
					</top>
					<size>
						<width>50</width>
					</size>
				</anchored>
				<tabtarget>
					<next>circle</next>
					<prev>name</prev>
				</tabtarget>
				<font>sheettextsmall</font>
				<empty>melee</empty>
			</textlistitemvalue>

			<checkbox name="strainonattack">
				<anchored>
					<left>
						<anchor>left</anchor>
						<offset>366</offset>
					</left>
					<top>
						<anchor>top</anchor>
						<offset>3</offset>
					</top>
					<size>
						<width>15</width>
						<height>15</height>
					</size>
				</anchored>
				<script>
					function onInit()
						if window.strainonattack.getValue() == 1 then
							window.attackstrain.setVisible(true);
							window.strainonattack.setVisible(false);
						else
							window.attackstrain.setVisible(false);
							window.strainonattack.setVisible(true);
						end
					end
					function onClickDown(button, x, y)
						return false;
					end
					function onValueChanged()
						if window.strainonattack.getValue() == 1 then
							window.attackstrain.setVisible(true);
							window.strainonattack.setVisible(false);
						else
							window.attackstrain.setVisible(false);
							window.strainonattack.setVisible(true);
						end
					end
				</script>
			</checkbox>
			
			<checkbox name="strainondamage">
				<anchored>
					<left>
						<anchor>left</anchor>
						<offset>384</offset>
					</left>
					<top>
						<anchor>top</anchor>
						<offset>3</offset>
					</top>
					<size>
						<width>15</width>
						<height>15</height>
					</size>
				</anchored>
				<script>
					function onInit()
						if window.strainondamage.getValue() == 1 then
							window.damagestrain.setVisible(true);
							window.strainondamage.setVisible(false);
						else
							window.damagestrain.setVisible(false);
							window.strainondamage.setVisible(true);
						end
					end
					function onClickDown(button, x, y)
						return false;
					end
					function onValueChanged()
						if window.strainondamage.getValue() == 1 then
							window.damagestrain.setVisible(true);
							window.strainondamage.setVisible(false);
						else
							window.damagestrain.setVisible(false);
							window.strainondamage.setVisible(true);
						end
					end
				</script>
			</checkbox>


			<numberfield name="attackstrain"><!--{{{-->
				<anchored>
					<left>
						<anchor>left</anchor>
						<offset>363</offset>
					</left>
					<top>
						<anchor>top</anchor>
						<offset>-1</offset>
					</top>
					<size>
						<width>20</width>
					</size>
				</anchored>
				<frame>
					<name>modifier</name>
					<offset>2,2,2,2</offset>
				</frame>
				<keyeditframe>
					<name>sheetfocus</name>
					<offset>2,2,2,2</offset>
				</keyeditframe>
				<font>sheetnumber</font>
				<script>
					function onDoubleClick()
						if User.isHost() then
							userguy = GmIdentityManager.getCurrent();
						else
							userguy = User.getIdentityLabel();
						end
						window.windowlist.window.getDatabaseNode().getChild("health.damage").setValue(window.windowlist.window.getDatabaseNode().getChild("health.damage").getValue() + getValue());
						ChatManager.control.deliverMessage({ font = "narratorfont", text = "[" .. userguy .. "]" .. ": Attack roll Strain Damage [" .. window.name.getValue() .. " ( " .. getValue() ..")] --> " .. window.windowlist.window.getDatabaseNode().getChild("name").getValue(), mode = "emote"});

						if getValue() &gt;= window.windowlist.window.getDatabaseNode().getChild("health.woundthreshold.total").getValue() then
							window.windowlist.window.getDatabaseNode().getChild("health.wounds").setValue(window.windowlist.window.getDatabaseNode().getChild("health.wounds").getValue() + 1);
							ChatManager.control.deliverMessage({ font = "narratorfont", text = "[" .. userguy .. "]" .. ": Attack roll Strain Wound [" .. window.name.getValue() .. "] --> " .. window.windowlist.window.getDatabaseNode().getChild("name").getValue(), mode = "emote"});
						end
						if window.windowlist.window.getDatabaseNode().getChild("totdamage").getValue() &gt;= window.windowlist.window.getDatabaseNode().getChild("health.death.total").getValue() then
							ChatManager.control.deliverMessage({ font = "narratorfont", text = "[" .. userguy .. "]" .. ": Death [" .. window.name.getValue() .. "] --> " .. window.windowlist.window.getDatabaseNode().getChild("name").getValue(), mode = "emote"});
						elseif window.windowlist.window.getDatabaseNode().getChild("totdamage").getValue() &gt;= window.windowlist.window.getDatabaseNode().getChild("health.unconscious.total").getValue() then
							ChatManager.control.deliverMessage({ font = "narratorfont", text = "[" .. userguy .. "]" .. ": Unconscious [" .. window.name.getValue() .. "] --> " .. window.windowlist.window.getDatabaseNode().getChild("name").getValue(), mode = "emote"});
						end
							
					end
					function onHover(state)
						if state then
							setColor("#FF882222");
							setFrame("sheetfocus", 2, 2, 2, 2);
							window.setFrame("rowshade");
						else
							if hasFocus() == false then
								setColor(nil);
								setFrame("modifier", 2, 2, 2, 2);
								window.setFrame(nil);
							end
						end
					end
					function onWheel()
						return true;
					end
				</script>
				<readonly />
			</numberfield><!--}}}-->

			<numberfield name="damagestrain"><!--{{{-->
				<anchored>
					<left>
						<anchor>left</anchor>
						<offset>381</offset>
					</left>
					<top>
						<anchor>top</anchor>
						<offset>-1</offset>
					</top>
					<size>
						<width>20</width>
					</size>
				</anchored>
				<frame>
					<name>modifier</name>
					<offset>2,2,2,2</offset>
				</frame>
				<keyeditframe>
					<name>sheetfocus</name>
					<offset>2,2,2,2</offset>
				</keyeditframe>
				<font>sheetnumber</font>
				<script>
					function onDoubleClick()
						if User.isHost() then
							userguy = GmIdentityManager.getCurrent();
						else
							userguy = User.getIdentityLabel();
						end
						window.windowlist.window.getDatabaseNode().getChild("health.damage").setValue(window.windowlist.window.getDatabaseNode().getChild("health.damage").getValue() + getValue());
						ChatManager.control.deliverMessage({ font = "narratorfont", text = "[" .. userguy .. "]" .. ": Damage roll Strain Damage [" .. window.name.getValue() .. " ( " .. getValue() ..")] --> " .. window.windowlist.window.getDatabaseNode().getChild("name").getValue(), mode = "emote"});

						if getValue() &gt;= window.windowlist.window.getDatabaseNode().getChild("health.woundthreshold.total").getValue() then
							window.windowlist.window.getDatabaseNode().getChild("health.wounds").setValue(window.windowlist.window.getDatabaseNode().getChild("health.wounds").getValue() + 1);
							ChatManager.control.deliverMessage({ font = "narratorfont", text = "[" .. userguy .. "]" .. ": Damage roll Strain Wound [" .. window.name.getValue() .. "] --> " .. window.windowlist.window.getDatabaseNode().getChild("name").getValue(), mode = "emote"});
						end
						if window.windowlist.window.getDatabaseNode().getChild("totdamage").getValue() &gt;= window.windowlist.window.getDatabaseNode().getChild("health.death.total").getValue() then
							ChatManager.control.deliverMessage({ font = "narratorfont", text = "[" .. userguy .. "]" .. ": Death [" .. window.name.getValue() .. "] --> " .. window.windowlist.window.getDatabaseNode().getChild("name").getValue(), mode = "emote"});
						elseif window.windowlist.window.getDatabaseNode().getChild("totdamage").getValue() &gt;= window.windowlist.window.getDatabaseNode().getChild("health.unconscious.total").getValue() then
							ChatManager.control.deliverMessage({ font = "narratorfont", text = "[" .. userguy .. "]" .. ": Unconscious [" .. window.name.getValue() .. "] --> " .. window.windowlist.window.getDatabaseNode().getChild("name").getValue(), mode = "emote"});
						end
							
					end
					function onHover(state)
						if state then
							setColor("#FF882222");
							setFrame("sheetfocus", 2, 2, 2, 2);
							window.setFrame("rowshade");
						else
							if hasFocus() == false then
								setColor(nil);
								setFrame("modifier", 2, 2, 2, 2);
								window.setFrame(nil);
							end
						end
					end
					function onWheel()
						return true;
					end
				</script>
				<readonly />
			</numberfield><!--}}}-->

			<buttoncontrol name="fullattack">
				<anchored>
					<left>
						<anchor>left</anchor>
						<offset>398</offset>
					</left>
					<top>
						<anchor>top</anchor>
						<offset>0</offset>
					</top>
					<size>
						<width>20</width>
						<height>20</height>
					</size>
				</anchored>
				<icon>
					<normal>indicator_zoom</normal>
					<hover>indicator_casterprep</hover>
					<pressed>indicator_zoom</pressed>
				</icon> 	
				<script>
					function onButtonPress()
						win = Interface.openWindow("attackfull",window.getDatabaseNode());
					end
					function onHover(state)
						if state then
							window.setFrame("rowshade");
						else
							window.setFrame(nil);
						end
					end
				</script>
			</buttoncontrol>

			<windowreferencefield name="attack_notes_shortcut">
				<anchored>
					<right>
						<anchor>left</anchor>
						<offset>445</offset>
					</right>
					<top>
						<anchor>top</anchor>
						<offset>0</offset>
					</top>
					<size>
						<width>20</width>
						<height>20</height>
					</size>
				</anchored>
				<icon>
					<normal>button_openwindow</normal>
					<empty>button_emptytarget</empty>
					<pressed>button_emptytarget</pressed>
				</icon>
				<allowdrop />
			</windowreferencefield>

				
		</sheetdata>
	</windowclass>
</root>